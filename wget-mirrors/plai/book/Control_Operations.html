<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html><head><meta http-equiv="content-type" content="text/html; charset=utf-8"/><title>14&nbsp;Control Operations</title><link rel="stylesheet" type="text/css" href="scribble.css" title="default"/><link rel="stylesheet" type="text/css" href="racket.css" title="default"/><link rel="stylesheet" type="text/css" href="scribble-style.css" title="default"/><script type="text/javascript" src="scribble-common.js"></script><!--[if IE 6]><style type="text/css">.SIEHidden { overflow: hidden; }</style><![endif]--></head><body id="scribble-racket-lang-org"><div class="tocset"><div class="tocview"><div class="tocviewlist tocviewlisttopspace"><div class="tocviewtitle"><table cellspacing="0" cellpadding="0"><tr><td style="width: 1em;"><a href="javascript:void(0);" title="Expand/Collapse" class="tocviewtoggle" onclick="TocviewToggle(this,&quot;tocview_0&quot;);">&#9660;</a></td><td></td><td><a href="index.html" class="tocviewlink" data-pltdoc="x">Programming Languages:<span class="mywbr"> &nbsp;</span> Application and Interpretation</a></td></tr></table></div><div class="tocviewsublisttop" style="display: block;" id="tocview_0"><table cellspacing="0" cellpadding="0"><tr><td align="right">1&nbsp;</td><td><a href="Introduction.html" class="tocviewlink" data-pltdoc="x">Introduction</a></td></tr><tr><td align="right">2&nbsp;</td><td><a href="Everything__We_Will_Say__About_Parsing.html" class="tocviewlink" data-pltdoc="x">Everything (We Will Say) About Parsing</a></td></tr><tr><td align="right">3&nbsp;</td><td><a href="first-interp.html" class="tocviewlink" data-pltdoc="x">A First Look at Interpretation</a></td></tr><tr><td align="right">4&nbsp;</td><td><a href="first-desugar.html" class="tocviewlink" data-pltdoc="x">A First Taste of Desugaring</a></td></tr><tr><td align="right">5&nbsp;</td><td><a href="adding-functions.html" class="tocviewlink" data-pltdoc="x">Adding Functions to the Language</a></td></tr><tr><td align="right">6&nbsp;</td><td><a href="From_Substitution_to_Environments.html" class="tocviewlink" data-pltdoc="x">From Substitution to Environments</a></td></tr><tr><td align="right">7&nbsp;</td><td><a href="higher-order-functions.html" class="tocviewlink" data-pltdoc="x">Functions Anywhere</a></td></tr><tr><td align="right">8&nbsp;</td><td><a href="mut-struct-vs-var.html" class="tocviewlink" data-pltdoc="x">Mutation:<span class="mywbr"> &nbsp;</span> Structures and Variables</a></td></tr><tr><td align="right">9&nbsp;</td><td><a href="recursion.html" class="tocviewlink" data-pltdoc="x">Recursion and Cycles:<span class="mywbr"> &nbsp;</span> Procedures and Data</a></td></tr><tr><td align="right">10&nbsp;</td><td><a href="Objects.html" class="tocviewlink" data-pltdoc="x">Objects</a></td></tr><tr><td align="right">11&nbsp;</td><td><a href="Memory_Management.html" class="tocviewlink" data-pltdoc="x">Memory Management</a></td></tr><tr><td align="right">12&nbsp;</td><td><a href="Representation_Decisions.html" class="tocviewlink" data-pltdoc="x">Representation Decisions</a></td></tr><tr><td align="right">13&nbsp;</td><td><a href="Desugaring_as_a_Language_Feature.html" class="tocviewlink" data-pltdoc="x">Desugaring as a Language Feature</a></td></tr><tr><td align="right">14&nbsp;</td><td><a href="" class="tocviewselflink" data-pltdoc="x">Control Operations</a></td></tr><tr><td align="right">15&nbsp;</td><td><a href="types.html" class="tocviewlink" data-pltdoc="x">Checking Program Invariants Statically:<span class="mywbr"> &nbsp;</span> Types</a></td></tr><tr><td align="right">16&nbsp;</td><td><a href="contracts.html" class="tocviewlink" data-pltdoc="x">Checking Program Invariants Dynamically:<span class="mywbr"> &nbsp;</span> Contracts</a></td></tr><tr><td align="right">17&nbsp;</td><td><a href="Alternate_Application_Semantics.html" class="tocviewlink" data-pltdoc="x">Alternate Application Semantics</a></td></tr></table></div></div><div class="tocviewlist"><table cellspacing="0" cellpadding="0"><tr><td style="width: 1em;"><a href="javascript:void(0);" title="Expand/Collapse" class="tocviewtoggle" onclick="TocviewToggle(this,&quot;tocview_1&quot;);">&#9658;</a></td><td>14&nbsp;</td><td><a href="" class="tocviewselflink" data-pltdoc="x">Control Operations</a></td></tr></table><div class="tocviewsublistbottom" style="display: none;" id="tocview_1"><table cellspacing="0" cellpadding="0"><tr><td align="right">14.1&nbsp;</td><td><a href="#%28part._.Control_on_the_.Web%29" class="tocviewlink" data-pltdoc="x">Control on the Web</a></td></tr><tr><td align="right">14.2&nbsp;</td><td><a href="#%28part._.Continuation-.Passing_.Style%29" class="tocviewlink" data-pltdoc="x">Continuation-<wbr></wbr>Passing Style</a></td></tr><tr><td align="right">14.3&nbsp;</td><td><a href="#%28part._.Generators%29" class="tocviewlink" data-pltdoc="x">Generators</a></td></tr><tr><td align="right">14.4&nbsp;</td><td><a href="#%28part._.Continuations_and_.Stacks%29" class="tocviewlink" data-pltdoc="x">Continuations and Stacks</a></td></tr><tr><td align="right">14.5&nbsp;</td><td><a href="#%28part._.Tail_.Calls%29" class="tocviewlink" data-pltdoc="x">Tail Calls</a></td></tr><tr><td align="right">14.6&nbsp;</td><td><a href="#%28part._.Continuations_as_a_.Language_.Feature%29" class="tocviewlink" data-pltdoc="x">Continuations as a Language Feature</a></td></tr></table></div></div></div><div class="tocsub"><div class="tocsubtitle">On this page:</div><table class="tocsublist" cellspacing="0"><tr><td><span class="tocsublinknumber">14.1<tt>&nbsp;</tt></span><a href="#%28part._.Control_on_the_.Web%29" class="tocsubseclink" data-pltdoc="x">Control on the Web</a></td></tr><tr><td><span class="tocsublinknumber">14.1.1<tt>&nbsp;</tt></span><a href="#%28part._.Program_.Decomposition_into_.Now_and_.Later%29" class="tocsubseclink" data-pltdoc="x">Program Decomposition into Now and Later</a></td></tr><tr><td><span class="tocsublinknumber">14.1.2<tt>&nbsp;</tt></span><a href="#%28part._.A_.Partial_.Solution%29" class="tocsubseclink" data-pltdoc="x">A Partial Solution</a></td></tr><tr><td><span class="tocsublinknumber">14.1.3<tt>&nbsp;</tt></span><a href="#%28part._.Achieving_.Statelessness%29" class="tocsubseclink" data-pltdoc="x">Achieving Statelessness</a></td></tr><tr><td><span class="tocsublinknumber">14.1.4<tt>&nbsp;</tt></span><a href="#%28part._.Interaction_with_.State%29" class="tocsubseclink" data-pltdoc="x">Interaction with State</a></td></tr><tr><td><span class="tocsublinknumber">14.2<tt>&nbsp;</tt></span><a href="#%28part._.Continuation-.Passing_.Style%29" class="tocsubseclink" data-pltdoc="x">Continuation-<wbr></wbr>Passing Style</a></td></tr><tr><td><span class="tocsublinknumber">14.2.1<tt>&nbsp;</tt></span><a href="#%28part._.Implementation_by_.Desugaring%29" class="tocsubseclink" data-pltdoc="x">Implementation by Desugaring</a></td></tr><tr><td><span class="Smaller"><a href="#%28elem._%28chunk._~3ccps-macro~3e~3a1%29%29" class="plainlink" data-pltdoc="x">&lt;cps-macro&gt;</a></span></td></tr><tr><td><span class="Smaller"><a href="#%28elem._%28chunk._~3ccps-macro-atomic-case~3e~3a1%29%29" class="plainlink" data-pltdoc="x">&lt;cps-macro-atomic-case&gt;</a></span></td></tr><tr><td><span class="Smaller"><a href="#%28elem._%28chunk._~3ccps-macro-quote-case~3e~3a1%29%29" class="plainlink" data-pltdoc="x">&lt;cps-macro-quote-case&gt;</a></span></td></tr><tr><td><span class="Smaller"><a href="#%28elem._%28chunk._~3ccps-macro-with-case~3e~3a1%29%29" class="plainlink" data-pltdoc="x">&lt;cps-macro-with-case&gt;</a></span></td></tr><tr><td><span class="Smaller"><a href="#%28elem._%28chunk._~3ccps-macro-rec-case~3e~3a1%29%29" class="plainlink" data-pltdoc="x">&lt;cps-macro-rec-case&gt;</a></span></td></tr><tr><td><span class="Smaller"><a href="#%28elem._%28chunk._~3ccps-macro-set-case~3e~3a1%29%29" class="plainlink" data-pltdoc="x">&lt;cps-macro-set-case&gt;</a></span></td></tr><tr><td><span class="Smaller"><a href="#%28elem._%28chunk._~3ccps-macro-seq-case~3e~3a1%29%29" class="plainlink" data-pltdoc="x">&lt;cps-macro-seq-case&gt;</a></span></td></tr><tr><td><span class="Smaller"><a href="#%28elem._%28chunk._~3ccps-macro-cnd-case~3e~3a1%29%29" class="plainlink" data-pltdoc="x">&lt;cps-macro-cnd-case&gt;</a></span></td></tr><tr><td><span class="Smaller"><a href="#%28elem._%28chunk._~3ccps-macro-app-1-case-take-1~3e~3a1%29%29" class="plainlink" data-pltdoc="x">&lt;cps-macro-app-1-case-take-1&gt;</a></span></td></tr><tr><td><span class="Smaller"><a href="#%28elem._%28chunk._~3ccps-macro-app-1-case~3e~3a1%29%29" class="plainlink" data-pltdoc="x">&lt;cps-macro-app-1-case&gt;</a></span></td></tr><tr><td><span class="Smaller"><a href="#%28elem._%28chunk._~3ccps-macro-app-2-case~3e~3a1%29%29" class="plainlink" data-pltdoc="x">&lt;cps-macro-app-2-case&gt;</a></span></td></tr><tr><td><span class="Smaller"><a href="#%28elem._%28chunk._~3ccps-macro-lam-case-take-1~3e~3a1%29%29" class="plainlink" data-pltdoc="x">&lt;cps-macro-lam-case-take-1&gt;</a></span></td></tr><tr><td><span class="Smaller"><a href="#%28elem._%28chunk._~3ccps-macro-lam-case~3e~3a1%29%29" class="plainlink" data-pltdoc="x">&lt;cps-macro-lam-case&gt;</a></span></td></tr><tr><td><span class="Smaller"><a href="#%28elem._%28chunk._~3ccps-macro-display-case~3e~3a1%29%29" class="plainlink" data-pltdoc="x">&lt;cps-macro-display-case&gt;</a></span></td></tr><tr><td><span class="Smaller"><a href="#%28elem._%28chunk._~3ccps-macro-read-number-case~3e~3a1%29%29" class="plainlink" data-pltdoc="x">&lt;cps-macro-read-number-case&gt;</a></span></td></tr><tr><td><span class="tocsublinknumber">14.2.2<tt>&nbsp;</tt></span><a href="#%28part._.Converting_the_.Example%29" class="tocsubseclink" data-pltdoc="x">Converting the Example</a></td></tr><tr><td><span class="tocsublinknumber">14.2.3<tt>&nbsp;</tt></span><a href="#%28part._.Implementation_in_the_.Core%29" class="tocsubseclink" data-pltdoc="x">Implementation in the Core</a></td></tr><tr><td><span class="Smaller"><a href="#%28elem._%28chunk._~3ccps-interp~3e~3a1%29%29" class="plainlink" data-pltdoc="x">&lt;cps-interp&gt;</a></span></td></tr><tr><td><span class="Smaller"><a href="#%28elem._%28chunk._~3ccps-interp-body~3e~3a1%29%29" class="plainlink" data-pltdoc="x">&lt;cps-interp-body&gt;</a></span></td></tr><tr><td><span class="Smaller"><a href="#%28elem._%28chunk._~3ccps-interp-plus.C-case~3e~3a1%29%29" class="plainlink" data-pltdoc="x">&lt;cps-interp-plusC-case&gt;</a></span></td></tr><tr><td><span class="Smaller"><a href="#%28elem._%28chunk._~3ccps-interp-app.C-case~3e~3a1%29%29" class="plainlink" data-pltdoc="x">&lt;cps-interp-appC-case&gt;</a></span></td></tr><tr><td><span class="Smaller"><a href="#%28elem._%28chunk._~3ccps-interp-lam.C-case~3e~3a1%29%29" class="plainlink" data-pltdoc="x">&lt;cps-interp-lamC-case&gt;</a></span></td></tr><tr><td><span class="tocsublinknumber">14.3<tt>&nbsp;</tt></span><a href="#%28part._.Generators%29" class="tocsubseclink" data-pltdoc="x">Generators</a></td></tr><tr><td><span class="tocsublinknumber">14.3.1<tt>&nbsp;</tt></span><a href="#%28part._.Design_.Variations%29" class="tocsubseclink" data-pltdoc="x">Design Variations</a></td></tr><tr><td><span class="tocsublinknumber">14.3.2<tt>&nbsp;</tt></span><a href="#%28part._.Implementing_.Generators%29" class="tocsubseclink" data-pltdoc="x">Implementing Generators</a></td></tr><tr><td><span class="Smaller"><a href="#%28elem._%28chunk._~3ccps-macro-generator-case~3e~3a1%29%29" class="plainlink" data-pltdoc="x">&lt;cps-macro-generator-case&gt;</a></span></td></tr><tr><td><span class="Smaller"><a href="#%28elem._%28chunk._~3cgenerator-body~3e~3a1%29%29" class="plainlink" data-pltdoc="x">&lt;generator-body&gt;</a></span></td></tr><tr><td><span class="Smaller"><a href="#%28elem._%28chunk._~3cgenerator-core~3e~3a1%29%29" class="plainlink" data-pltdoc="x">&lt;generator-core&gt;</a></span></td></tr><tr><td><span class="Smaller"><a href="#%28elem._%28chunk._~3cgenerator-value~3e~3a1%29%29" class="plainlink" data-pltdoc="x">&lt;generator-value&gt;</a></span></td></tr><tr><td><span class="tocsublinknumber">14.4<tt>&nbsp;</tt></span><a href="#%28part._.Continuations_and_.Stacks%29" class="tocsubseclink" data-pltdoc="x">Continuations and Stacks</a></td></tr><tr><td><span class="tocsublinknumber">14.5<tt>&nbsp;</tt></span><a href="#%28part._.Tail_.Calls%29" class="tocsubseclink" data-pltdoc="x">Tail Calls</a></td></tr><tr><td><span class="tocsublinknumber">14.6<tt>&nbsp;</tt></span><a href="#%28part._.Continuations_as_a_.Language_.Feature%29" class="tocsubseclink" data-pltdoc="x">Continuations as a Language Feature</a></td></tr><tr><td><span class="Smaller"><a href="#%28elem._%28chunk._~3ccps-macro-let%2Fcc-case~3e~3a1%29%29" class="plainlink" data-pltdoc="x">&lt;cps-macro-let/cc-case&gt;</a></span></td></tr><tr><td><span class="tocsublinknumber">14.6.1<tt>&nbsp;</tt></span><a href="#%28part._.Presentation_in_the_.Language%29" class="tocsubseclink" data-pltdoc="x">Presentation in the Language</a></td></tr><tr><td><span class="tocsublinknumber">14.6.2<tt>&nbsp;</tt></span><a href="#%28part._.Defining_.Generators%29" class="tocsubseclink" data-pltdoc="x">Defining Generators</a></td></tr><tr><td><span class="tocsublinknumber">14.6.3<tt>&nbsp;</tt></span><a href="#%28part._.Defining_.Threads%29" class="tocsubseclink" data-pltdoc="x">Defining Threads</a></td></tr><tr><td><span class="tocsublinknumber">14.6.4<tt>&nbsp;</tt></span><a href="#%28part._.Better_.Primitives_for_.Web_.Programming%29" class="tocsubseclink" data-pltdoc="x">Better Primitives for Web Programming</a></td></tr></table></div></div><div class="maincolumn"><div class="main"><div class="navsettop"><span class="navleft"><div class="nosearchform"></div>&nbsp;&nbsp;</span><span class="navright">&nbsp;&nbsp;<a href="Desugaring_as_a_Language_Feature.html" title="backward to &quot;13 Desugaring as a Language Feature&quot;" data-pltdoc="x">&larr; prev</a>&nbsp;&nbsp;<a href="index.html" title="up to &quot;Programming Languages: Application and Interpretation&quot;" data-pltdoc="x">up</a>&nbsp;&nbsp;<a href="types.html" title="forward to &quot;15 Checking Program Invariants Statically: Types&quot;" data-pltdoc="x">next &rarr;</a></span>&nbsp;</div><h3>14<tt>&nbsp;</tt><a name="(part._.Control_.Operations)"></a>Control Operations</h3><p>The term <span style="font-style: italic">control</span> refers to any programming language instruction
that causes evaluation to proceed, because it &ldquo;controls&rdquo; the program
counter of the machine.  In that sense, even a simple arithmetic
expression should qualify as &ldquo;control&rdquo;, and operations such as
sequential program execution, or function calls and returns, most
certainly do.  However, in practice we use the term to refer primarily
to those operations that cause <span style="font-style: italic">non-local</span> transfer of control,
especially beyond that of mere functions and procedures, and the next
step up, namely exceptions.  We will study such operations in this
chapter.</p><p>As we study the following control operators, it&rsquo;s worth remembering
that even without them, we still have languages that are
Turing-complete, and therefore have no more &ldquo;power&rdquo;.  Therefore,
what control operators do is change and potentially improve the way we
express our intent, and therefore enhance the structure of programs.
Thus, it pays to being our study by focusing on program structure.</p><h4>14.1<tt>&nbsp;</tt><a name="(part._.Control_on_the_.Web)"></a>Control on the Web</h4><p><div class="SIntrapara">Let us begin our study by examining the structure of Web programs.
Consider the following program:<span class="refelem"><span class="refcolumn"><span class="refcontent">Henceforth, we&rsquo;ll call
this our &ldquo;addition server&rdquo;.  You should, of course, understand this
as a stand-in for more sophisticated applications.  For instance, the
two prompts might ask for starting and ending points for a trip, and
in place of addition we might compute a route or compute airfares.
There might even be computation between the two steps: e.g., after
entering the first city, the airline might prompt us with choices of
where it flies from there.</span></span></span>
</div><div class="SIntrapara"><blockquote class="SCodeFlow"><table cellspacing="0" cellpadding="0" class="RktBlk"><tr><td><span class="RktPn">(</span><span class="RktMeta">display</span></td></tr><tr><td><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktMeta">+</span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktMeta">read-number</span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktVal">"First</span><span class="hspace">&nbsp;</span><span class="RktVal">number"</span><span class="RktPn">)</span><span class="RktMeta"></span></td></tr><tr><td><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktMeta">read-number</span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktVal">"Second</span><span class="hspace">&nbsp;</span><span class="RktVal">number"</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktMeta"></span></td></tr></table></blockquote></div><div class="SIntrapara">To test these ideas, here&rsquo;s an implementation of <span class="stt">read-number</span>:
</div><div class="SIntrapara"><blockquote class="SCodeFlow"><table cellspacing="0" cellpadding="0" class="RktBlk"><tr><td><span class="RktPn">(</span><span class="RktMeta">define</span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktMeta">read-number</span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktPn">[</span><span class="RktMeta">prompt</span><span class="hspace">&nbsp;</span><span class="RktMeta">:</span><span class="hspace">&nbsp;</span><span class="RktMeta">string</span><span class="RktPn">]</span><span class="RktPn">)</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta">:</span><span class="hspace">&nbsp;</span><span class="RktMeta">number</span></td></tr><tr><td><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktMeta">begin</span></td></tr><tr><td><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktMeta">display</span><span class="hspace">&nbsp;</span><span class="RktMeta">prompt</span><span class="RktPn">)</span><span class="RktMeta"></span></td></tr><tr><td><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktMeta">let</span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktPn">[</span><span class="RktMeta">v</span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktMeta">read</span><span class="RktPn">)</span><span class="RktPn">]</span><span class="RktPn">)</span><span class="RktMeta"></span></td></tr><tr><td><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktMeta">if</span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktMeta">s-exp-number?</span><span class="hspace">&nbsp;</span><span class="RktMeta">v</span><span class="RktPn">)</span><span class="RktMeta"></span></td></tr><tr><td><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktMeta">s-exp-&gt;number</span><span class="hspace">&nbsp;</span><span class="RktMeta">v</span><span class="RktPn">)</span><span class="RktMeta"></span></td></tr><tr><td><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktMeta">read-number</span><span class="hspace">&nbsp;</span><span class="RktMeta">prompt</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktMeta"></span></td></tr></table></blockquote></div><div class="SIntrapara">When run at the console or in DrRacket, this program prompts us for
one number, then another, and then displays their sum.</div></p><p>Now suppose we want to run this on a Web server.  We immediately
encounter a difficulty: the structure of server-side Web programs is
such that they generate a single Web page&#8212;<wbr></wbr>such as the one asking for
the first number&#8212;<wbr></wbr>and then <span style="font-style: italic">halt</span>.  As a result, the <span style="font-style: italic">rest
of the program</span>&#8212;<wbr></wbr>which in this case prompts for the second number,
then adds them, and then prints that result, is lost.</p><p><div class="SIntrapara"><span style="font-weight: bold">Do Now!</span></div><div class="SIntrapara"><blockquote><p>Why do Web servers behave in such a strange way?</p></blockquote></div></p><p>There are at least two reasons for this behavior: one perhaps
historical, and the other technical.  The historical reason is that
Web servers were initially designed to serve <span style="font-style: italic">pages</span>, i.e.,
static content.  Any program that ran had to generate its output to a
file, from which a server could offer it.  Naturally, developers
wondered why that same program couldn&rsquo;t run on demand.  This made Web
content <span style="font-style: italic">dynamic</span>.  Terminating the program after generating a
single piece of output was the simplest incremental step towards
programs, not pages, on the Web.</p><p>The more important reason&#8212;<wbr></wbr>and the one that has stayed with us&#8212;<wbr></wbr>is
technical.  Imagine our addition server has generated its first
prompt.  Recall that there is considerable pending computation: the
second prompt, the addition, and the display of the result.  This
computation must suspend waiting for the user&rsquo;s input.  If there are
millions of users, then millions of computations must be suspended,
creating an enormous performance problem.  Furthermore, suppose a user
does not actually complete the computation&#8212;<wbr></wbr>analogous to searching at
an on-line bookstore or airline site, but not completing the
purchase.  How does the server know when or even whether to terminate
the computation?  And until it does, the resources associated with
that computation remain in use.</p><p>Conceptually, therefore, the Web protocol was designed to be
<span style="font-style: italic">stateless</span>: it would not store state on the server associated
with intermediate computations.  Instead, Web program developers would
be forced to maintain all necessary state elsewhere, and each request
would need to be able to resume the computation in full.  In practice,
the Web has not proven to be stateless at all, but it still hews
largely in this direction, and studying the structure of such programs
is very instructive.</p><p>Now consider client-side Web programs: those that run inside the
browser, written in or compiled to JavaScript.  Suppose such a
computation needs to communicate with a server.  The primitive for
this is called <span class="stt">XMLHttpRequest</span>.  The user makes an instance of
this primitive and invokes its <span class="stt">send</span> method to send a message to
the server.  Communicating with a server is not, however,
instantaneous (and indeed may never complete, depending on the state
of the network).  This leaves the sending process suspended.</p><p>The designers of JavaScript decided to make the language
<span style="font-style: italic">single-threaded</span>: i.e., there would be only one thread of
execution at a time.<span class="refelem"><span class="refcolumn"><span class="refcontent">Due to the structuring problems this
causes, there are now various proposals to, in effect, add &ldquo;safe&rdquo;
threads to JavaScript.  The ideas described in this chapter can be
viewed as an alternative that offer similar structuring benefits.</span></span></span>
This avoids the various perils that arise from combining mutation with
threads.  As a result, however, the JavaScript process locks up
awaiting the response, and nothing else can happen: e.g., other
handlers on the page no longer respond.</p><p>To avoid this problem, the design of <span class="stt">XMLHttpRequest</span> demands
that the developer provide a procedure that responds to the request if
and when it arrives.  This callback procedure is registered with the
system.  It needs to embody the <span style="font-style: italic">rest of the processing</span> of that
request.  Thus, for entirely different reasons&#8212;<wbr></wbr>not performance, but
avoiding the problems of synchronization, non-atomicity, and
deadlocks&#8212;<wbr></wbr>the client-side Web has evolved to demand the same
pattern of developers.  Let us now better understand that pattern.</p><h5>14.1.1<tt>&nbsp;</tt><a name="(part._.Program_.Decomposition_into_.Now_and_.Later)"></a>Program Decomposition into Now and Later</h5><p><div class="SIntrapara">Let us consider what it takes to make our above program work in a
stateless setting, such as on a Web server.  First we have to
determine the <span style="font-style: italic">first</span> interaction.  This is the prompt for the
first number, because Racket evaluates arguments from left to right.
It is instructive to divide the program into two parts: what happens
to generate the first interaction (which can all run now), and what
needs to happen after it (which must be &ldquo;remembered&rdquo; somehow).  The
former is easy:
</div><div class="SIntrapara"><blockquote class="SCodeFlow"><table cellspacing="0" cellpadding="0" class="RktBlk"><tr><td><span class="RktPn">(</span><span class="RktMeta">read-number</span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktVal">"First</span><span class="hspace">&nbsp;</span><span class="RktVal">number"</span><span class="RktPn">)</span><span class="RktMeta"></span></td></tr></table></blockquote></div><div class="SIntrapara">We&rsquo;ve already explained in prose what&rsquo;s left, but now it&rsquo;s time to
write it <span style="font-style: italic">as a program</span>.  It seems to be something
like<span class="refelem"><span class="refcolumn"><span class="refcontent">We&rsquo;re intentionally ignoring <span class="stt">read-number</span> for
now, but we&rsquo;ll return to it.  For now, let&rsquo;s pretend it&rsquo;s built-in.</span></span></span>
</div><div class="SIntrapara"><blockquote class="SCodeFlow"><table cellspacing="0" cellpadding="0" class="RktBlk"><tr><td><span class="RktPn">(</span><span class="RktMeta">display</span></td></tr><tr><td><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktMeta">+</span><span class="hspace">&nbsp;</span><span class="RktMeta">&lt;the</span><span class="hspace">&nbsp;</span><span class="RktMeta">result</span><span class="hspace">&nbsp;</span><span class="RktMeta">from</span><span class="hspace">&nbsp;</span><span class="RktMeta">the</span><span class="hspace">&nbsp;</span><span class="RktMeta">first</span><span class="hspace">&nbsp;</span><span class="RktMeta">interaction&gt;</span></td></tr><tr><td><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktMeta">read-number</span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktVal">"Second</span><span class="hspace">&nbsp;</span><span class="RktVal">number"</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktMeta"></span></td></tr></table></blockquote></div><div class="SIntrapara">A Web server can&rsquo;t execute the above, however, because it evidently
isn&rsquo;t a <span style="font-style: italic">program</span>.  We instead need some way of writing this as
one.</div></p><p><div class="SIntrapara">Let&rsquo;s observe a few characteristics of this computation:
</div><div class="SIntrapara"><ul><li><p>It needs to be a legitimate program.</p></li><li><p>It needs to stay suspended until the request comes in.</p></li><li><p>It needs a way&#8212;<wbr></wbr>such as a parameter&#8212;<wbr></wbr>to refer to the value
from the first interaction.</p></li></ul></div><div class="SIntrapara">Put together these characteristics and we have a clear
representation&#8212;<wbr></wbr>a <span style="font-style: italic">function</span>:
</div><div class="SIntrapara"><blockquote class="SCodeFlow"><table cellspacing="0" cellpadding="0" class="RktBlk"><tr><td><span class="RktPn">(</span><span class="RktMeta">lambda</span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktMeta">v1</span><span class="RktPn">)</span><span class="RktMeta"></span></td></tr><tr><td><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktMeta">display</span></td></tr><tr><td><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktMeta">+</span><span class="hspace">&nbsp;</span><span class="RktMeta">v1</span></td></tr><tr><td><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktMeta">read-number</span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktVal">"Second</span><span class="hspace">&nbsp;</span><span class="RktVal">number"</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktMeta"></span></td></tr></table></blockquote></div></p><h5>14.1.2<tt>&nbsp;</tt><a name="(part._.A_.Partial_.Solution)"></a>A Partial Solution</h5><p>On the Web, there is an additional wrinkle: each Web page with input
elements needs to refer to a program stored on the Web, which will
receive the data from the form and process it.  This program is named
in the <span class="stt">action</span> field of a form.  Thus, imagine that the server
generates a fresh label, stores the above function in a table
associated with that label, and refers to the table in the
<span class="stt">action</span> field.  If and when the client actually submits the
form, the server extracts the associated function, supplies it with
the form&rsquo;s values, and thus resumes execution.</p><p><div class="SIntrapara"><span style="font-weight: bold">Do Now!</span></div><div class="SIntrapara"><blockquote><p>Is the solution above stateless?</p></blockquote></div></p><p><div class="SIntrapara">Let&rsquo;s imagine that we have a custom Web server that maintains the
above table.  In such a server, we might have a special version of
<span class="stt">read-number</span>&#8212;<wbr></wbr>call it <span class="stt">read-number/suspend</span>&#8212;<wbr></wbr>that records
the rest of the program:
</div><div class="SIntrapara"><blockquote class="SCodeFlow"><table cellspacing="0" cellpadding="0" class="RktBlk"><tr><td><span class="RktPn">(</span><span class="RktMeta">read-number/suspend</span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktVal">"First</span><span class="hspace">&nbsp;</span><span class="RktVal">number"</span><span class="RktMeta"></span></td></tr><tr><td><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktMeta">lambda</span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktMeta">v1</span><span class="RktPn">)</span><span class="RktMeta"></span></td></tr><tr><td><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktMeta">display</span></td></tr><tr><td><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktMeta">+</span><span class="hspace">&nbsp;</span><span class="RktMeta">v1</span></td></tr><tr><td><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktMeta">read-number</span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktVal">"Second</span><span class="hspace">&nbsp;</span><span class="RktVal">number"</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktMeta"></span></td></tr></table></blockquote></div><div class="SIntrapara">To test this, let&rsquo;s implement such a procedure.  First, we need a
representation for labels; numbers are an easy substitute:
</div><div class="SIntrapara"><blockquote class="SCodeFlow"><table cellspacing="0" cellpadding="0" class="RktBlk"><tr><td><span class="RktPn">(</span><span class="RktMeta">define-type-alias</span><span class="hspace">&nbsp;</span><span class="RktMeta">label</span><span class="hspace">&nbsp;</span><span class="RktMeta">number</span><span class="RktPn">)</span><span class="RktMeta"></span></td></tr></table></blockquote></div><div class="SIntrapara">Let&rsquo;s say <span class="stt">new-label</span> generates a fresh label on each invocation.</div></p><p><div class="SIntrapara"><span style="font-weight: bold">Exercise</span></div><div class="SIntrapara"><blockquote><p>Define <span class="stt">new-label</span>.  You might use <span class="stt">new-loc</span> for
inspiration.</p></blockquote></div></p><p><div class="SIntrapara">We need a table to store the procedures representing the rest of the
program.
</div><div class="SIntrapara"><blockquote class="SCodeFlow"><table cellspacing="0" cellpadding="0" class="RktBlk"><tr><td><span class="RktPn">(</span><span class="RktMeta">define</span><span class="hspace">&nbsp;</span><span class="RktMeta">table</span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktMeta">make-hash</span><span class="hspace">&nbsp;</span><span class="RktMeta">empty</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktMeta"></span></td></tr></table></blockquote></div><div class="SIntrapara">Now we can store these procedures:
</div><div class="SIntrapara"><blockquote class="SCodeFlow"><table cellspacing="0" cellpadding="0" class="RktBlk"><tr><td><span class="RktPn">(</span><span class="RktMeta">define</span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktMeta">read-number/suspend</span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktPn">[</span><span class="RktMeta">prompt</span><span class="hspace">&nbsp;</span><span class="RktMeta">:</span><span class="hspace">&nbsp;</span><span class="RktMeta">string</span><span class="RktPn">]</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta">rest</span><span class="RktPn">)</span><span class="RktMeta"></span></td></tr><tr><td><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktMeta">let</span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktPn">[</span><span class="RktMeta">g</span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktMeta">new-label</span><span class="RktPn">)</span><span class="RktPn">]</span><span class="RktPn">)</span><span class="RktMeta"></span></td></tr><tr><td><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktMeta">begin</span></td></tr><tr><td><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktMeta">hash-set!</span><span class="hspace">&nbsp;</span><span class="RktMeta">table</span><span class="hspace">&nbsp;</span><span class="RktMeta">g</span><span class="hspace">&nbsp;</span><span class="RktMeta">rest</span><span class="RktPn">)</span><span class="RktMeta"></span></td></tr><tr><td><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktMeta">display</span><span class="hspace">&nbsp;</span><span class="RktMeta">prompt</span><span class="RktPn">)</span><span class="RktMeta"></span></td></tr><tr><td><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktMeta">display</span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktVal">"</span><span class="hspace">&nbsp;</span><span class="RktVal">To</span><span class="hspace">&nbsp;</span><span class="RktVal">enter</span><span class="hspace">&nbsp;</span><span class="RktVal">it,</span><span class="hspace">&nbsp;</span><span class="RktVal">use</span><span class="hspace">&nbsp;</span><span class="RktVal">the</span><span class="hspace">&nbsp;</span><span class="RktVal">action</span><span class="hspace">&nbsp;</span><span class="RktVal">field</span><span class="hspace">&nbsp;</span><span class="RktVal">label</span><span class="hspace">&nbsp;</span><span class="RktVal">"</span><span class="RktPn">)</span><span class="RktMeta"></span></td></tr><tr><td><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktMeta">display</span><span class="hspace">&nbsp;</span><span class="RktMeta">g</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktMeta"></span></td></tr></table></blockquote></div><div class="SIntrapara">If we now run the above invocation of <span class="stt">read-number/suspend</span>, the
system prints
</div><div class="SIntrapara"><table cellspacing="0" cellpadding="0"><tr><td><p><span class="stt">First number To enter it, use the action field label 1</span></p></td></tr></table></div><div class="SIntrapara">This is tantamount to printing the prompt in a Web page, and putting
the label <span class="stt">1</span> in the <span class="stt">action</span> field.  Because we&rsquo;re
simulating it, we need something to represent the browser&rsquo;s submission
process.  This needs both the label (from the <span class="stt">action</span> field) and
the value entered in the form.  Given these two values, this procedure
needs to extract the relevant procedure from the table, and apply it
to the form value.
</div><div class="SIntrapara"><blockquote class="SCodeFlow"><table cellspacing="0" cellpadding="0" class="RktBlk"><tr><td><span class="RktPn">(</span><span class="RktMeta">define</span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktMeta">resume</span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktPn">[</span><span class="RktMeta">g</span><span class="hspace">&nbsp;</span><span class="RktMeta">:</span><span class="hspace">&nbsp;</span><span class="RktMeta">label</span><span class="RktPn">]</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktPn">[</span><span class="RktMeta">n</span><span class="hspace">&nbsp;</span><span class="RktMeta">:</span><span class="hspace">&nbsp;</span><span class="RktMeta">number</span><span class="RktPn">]</span><span class="RktPn">)</span><span class="RktMeta"></span></td></tr><tr><td><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktPn">(</span><span class="RktMeta">some-v</span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktMeta">hash-ref</span><span class="hspace">&nbsp;</span><span class="RktMeta">table</span><span class="hspace">&nbsp;</span><span class="RktMeta">g</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta">n</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktMeta"></span></td></tr></table></blockquote></div></p><p><div class="SIntrapara">With this, we can now simulate the act of entering <span class="stt">3</span> and
clicking on a &ldquo;Submit&rdquo; button by running:
</div><div class="SIntrapara"><table cellspacing="0" cellpadding="0"><tr><td><p><span class="stt">&gt; (resume 1 3)</span></p></td></tr></table></div><div class="SIntrapara">where <span class="stt">1</span> is the label and <span class="stt">3</span> is the user&rsquo;s input.
Unfortunately, this simply produces another prompt, because we haven&rsquo;t
fully converted the program.  If we delete <span class="stt">read-number</span>, we&rsquo;re
forced to convert the entire program:
</div><div class="SIntrapara"><blockquote class="SCodeFlow"><table cellspacing="0" cellpadding="0" class="RktBlk"><tr><td><span class="RktPn">(</span><span class="RktMeta">read-number/suspend</span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktVal">"First</span><span class="hspace">&nbsp;</span><span class="RktVal">number"</span><span class="RktMeta"></span></td></tr><tr><td><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktMeta">lambda</span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktMeta">v1</span><span class="RktPn">)</span><span class="RktMeta"></span></td></tr><tr><td><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktMeta">read-number/suspend</span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktVal">"Second</span><span class="hspace">&nbsp;</span><span class="RktVal">number"</span><span class="RktMeta"></span></td></tr><tr><td><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktMeta">lambda</span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktMeta">v2</span><span class="RktPn">)</span><span class="RktMeta"></span></td></tr><tr><td><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktMeta">display</span></td></tr><tr><td><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktMeta">+</span><span class="hspace">&nbsp;</span><span class="RktMeta">v1</span><span class="hspace">&nbsp;</span><span class="RktMeta">v2</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktMeta"></span></td></tr></table></blockquote></div><div class="SIntrapara">Just to be safe, we can also make sure the computation terminates
after each output by adding an <span class="stt">error</span> invocation at the end of
<span class="stt">read-number/suspend</span> (to truly ensure the most extreme form of
&ldquo;suspension&rdquo;).</div></p><p><div class="SIntrapara">When we execute this program, we have to use <span class="stt">resume</span> twice:
</div><div class="SIntrapara"><table cellspacing="0" cellpadding="0"><tr><td><p><span class="stt">First number To enter it, use the action field label 1</span></p></td></tr><tr><td><p><span class="stt">halting: Program shut down</span></p></td></tr><tr><td><p><span class="stt">&gt; (resume 1 3)</span></p></td></tr><tr><td><p><span class="stt">Second number To enter it, use the action field label 2</span></p></td></tr><tr><td><p><span class="stt">halting: Program shut down</span></p></td></tr><tr><td><p><span class="stt">&gt; (resume 2 10)</span></p></td></tr><tr><td><p><span class="stt">13</span></p></td></tr></table></div><div class="SIntrapara">where the two user inputs are <span class="stt">3</span> and <span class="stt">10</span>, giving a total
of <span class="stt">13</span>, and the </div><div class="SIntrapara"><table cellspacing="0" cellpadding="0"><tr><td><p><span class="stt">halting</span></p></td></tr></table></div><div class="SIntrapara"> messages are generated by the
<span class="stt">error</span> command we inserted.</div></p><p>We&rsquo;ve purposely played a little coy with the types of the interesting
parts of our program.  Let&rsquo;s examine what these types should be.  The
second argument to <span class="stt">read-number/suspend</span> needs to be a procedure
that consumes numbers and returns whatever the computation eventually
produces: <span class="stt">(number -&gt; </span><span class="stt">&rsquo;</span><span class="stt">a)</span>.  Similarly, the return type of
<span class="stt">resume</span> is the same <span class="stt"></span><span class="stt">&rsquo;</span><span class="stt">a</span>.  How do these <span class="stt"></span><span class="stt">&rsquo;</span><span class="stt">a</span>s
communicate with one another?  This is done by <span class="stt">table</span>, which
maps labels to <span class="stt">(number -&gt; </span><span class="stt">&rsquo;</span><span class="stt">a)</span>.  That is, at every step the
computation makes progress towards the same outcome.
<span class="stt">read-number/suspend</span> writes into this table, and <span class="stt">resume</span>
reads from it.</p><h5>14.1.3<tt>&nbsp;</tt><a name="(part._.Achieving_.Statelessness)"></a>Achieving Statelessness</h5><p>We haven&rsquo;t actually achieved statelessness yet, because we have this
large table residing on the server, with no clear means to remove
entries from it.  It would be better if we could avoid the server
state entirely.  This means we have to move the relevant state to the
client.</p><p>There are actually two ways in which the server holds state.  One is
that we have reserved the right to create as many entries in the hash
table as we wish, rather than a constant number (i.e., linear in the
size of the program itself).  The other is what we&rsquo;re storing in the
table: honest-to-goodness closures, which might be holding on to an
arbitrary amount of state.  We&rsquo;ll see this more clearly soon.</p><p><div class="SIntrapara">Let&rsquo;s start by eliminating the closure.  Instead, let&rsquo;s have each of
the funtion arguments to be named, top-level functions (which
immediately forces us to have only a fixed number of them, because the
program&rsquo;s size cannot be unbounded):
</div><div class="SIntrapara"><blockquote class="SCodeFlow"><table cellspacing="0" cellpadding="0" class="RktBlk"><tr><td><span class="RktPn">(</span><span class="RktMeta">read-number/stateless</span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktVal">"First</span><span class="hspace">&nbsp;</span><span class="RktVal">number"</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta">prog1</span><span class="RktPn">)</span><span class="RktMeta"></span></td></tr><tr><td><span class="RktMeta">&#160;</span></td></tr><tr><td><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktMeta">define</span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktMeta">prog1</span><span class="hspace">&nbsp;</span><span class="RktMeta">v1</span><span class="RktPn">)</span><span class="RktMeta"></span></td></tr><tr><td><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktMeta">read-number/stateless</span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktVal">"Second</span><span class="hspace">&nbsp;</span><span class="RktVal">number"</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta">prog2</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktMeta"></span></td></tr><tr><td><span class="RktMeta">&#160;</span></td></tr><tr><td><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktMeta">define</span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktMeta">prog2</span><span class="hspace">&nbsp;</span><span class="RktMeta">v2</span><span class="RktPn">)</span><span class="RktMeta"></span></td></tr><tr><td><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktMeta">display</span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktMeta">+</span><span class="hspace">&nbsp;</span><span class="RktMeta">v1</span><span class="hspace">&nbsp;</span><span class="RktMeta">v2</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktMeta"></span></td></tr></table></blockquote></div><div class="SIntrapara">Observe how each code block refers only to the <span style="font-style: italic">name</span> of the
next, rather than to a real closure.  The value of the argument comes
from the form.  There&rsquo;s just one problem: <span class="stt">v1</span> in <span class="stt">prog2</span> is
a free identifier!</div></p><p>The way to fix this problem is, instead of creating a closure after
one step, to send <span class="stt">v1</span> to the client to be stored there.  Where
do we store this?  The browser offers two mechanisms for doing this:
<span style="font-style: italic">cookies</span> and <span style="font-style: italic">hidden fields</span>.  Which one do we use?</p><h5>14.1.4<tt>&nbsp;</tt><a name="(part._.Interaction_with_.State)"></a>Interaction with State</h5><p>The fundamental difference between cookies and hidden fields is that
<span style="font-style: italic">all pages share the same cookie, but each page has its own
hidden fields</span>.</p><p><div class="SIntrapara">First, let&rsquo;s consider a sequence of interactions with the existing
program that uses <span class="stt">read-number/suspend</span> (at both interaction
points).  It looks like this:
</div><div class="SIntrapara"><table cellspacing="0" cellpadding="0"><tr><td><p><span class="stt">First number To enter it, use the action field label 1</span></p></td></tr><tr><td><p><span class="stt">&gt; (resume 1 3)</span></p></td></tr><tr><td><p><span class="stt">Second number To enter it, use the action field label 2</span></p></td></tr><tr><td><p><span class="stt">&gt; (resume 2 10)</span></p></td></tr><tr><td><p><span class="stt">13</span></p></td></tr></table></div><div class="SIntrapara">Thus, resuming with label <span class="stt">2</span> appears to represent adding
<span class="stt">3</span> to the given argument (i.e., form field value).  To be sure,
</div><div class="SIntrapara"><table cellspacing="0" cellpadding="0"><tr><td><p><span class="stt">&gt; (resume 2 15)</span></p></td></tr><tr><td><p><span class="stt">18</span></p></td></tr></table></div><div class="SIntrapara">So far, so good.  Now suppose we use label <span class="stt">1</span> again:
</div><div class="SIntrapara"><table cellspacing="0" cellpadding="0"><tr><td><p><span class="stt">&gt; (resume 1 5)</span></p></td></tr><tr><td><p><span class="stt">Second number To enter it, use the action field label 3</span></p></td></tr></table></div><div class="SIntrapara">Observe that this new program execution needs to be resumed by using
label <span class="stt">3</span>, not <span class="stt">1</span>.  Indeed,
</div><div class="SIntrapara"><table cellspacing="0" cellpadding="0"><tr><td><p><span class="stt">&gt; (resume 3 10)</span></p></td></tr><tr><td><p><span class="stt">15</span></p></td></tr></table></div><div class="SIntrapara">But we ought to ask, what happens if we reuse label <span class="stt">2</span>?</div></p><p><div class="SIntrapara"><span style="font-weight: bold">Do Now!</span></div><div class="SIntrapara"><blockquote><p>Try <span class="stt">(resume 2 10)</span>.</p></blockquote></div></p><p><div class="SIntrapara">Doing this is tantamount to resuming the old computation.  We
therefore expect it produce the same answer as before:
</div><div class="SIntrapara"><table cellspacing="0" cellpadding="0"><tr><td><p><span class="stt">&gt; (resume 2 10)</span></p></td></tr><tr><td><p><span class="stt">13</span></p></td></tr></table></div></p><p><div class="SIntrapara">Now let&rsquo;s create a stateful implementation.  We can simulate this by
observing that each closure has its own environment, but all closures
share the same mutable state.  We can simulate this using our existing
<span class="stt">read-number/suspend</span> by making sure we don&rsquo;t rely on the closure
behavior of <span class="stt">lambda</span>, i.e., by not having any free identifiers in
the body.
</div><div class="SIntrapara"><blockquote class="SCodeFlow"><table cellspacing="0" cellpadding="0" class="RktBlk"><tr><td><span class="RktPn">(</span><span class="RktMeta">define</span><span class="hspace">&nbsp;</span><span class="RktMeta">cookie</span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktVal">'</span><span class="RktVal">-100</span><span class="RktPn">)</span><span class="RktMeta"></span></td></tr><tr><td><span class="RktMeta">&#160;</span></td></tr><tr><td><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktMeta">read-number/suspend</span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktVal">"First</span><span class="hspace">&nbsp;</span><span class="RktVal">number"</span><span class="RktMeta"></span></td></tr><tr><td><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktMeta">lambda</span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktMeta">v1</span><span class="RktPn">)</span><span class="RktMeta"></span></td></tr><tr><td><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktMeta">begin</span></td></tr><tr><td><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktMeta">set!</span><span class="hspace">&nbsp;</span><span class="RktMeta">cookie</span><span class="hspace">&nbsp;</span><span class="RktMeta">v1</span><span class="RktPn">)</span><span class="RktMeta"></span></td></tr><tr><td><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktMeta">read-number/suspend</span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktVal">"Second</span><span class="hspace">&nbsp;</span><span class="RktVal">number"</span><span class="RktMeta"></span></td></tr><tr><td><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktMeta">lambda</span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktMeta">v2</span><span class="RktPn">)</span><span class="RktMeta"></span></td></tr><tr><td><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktMeta">display</span></td></tr><tr><td><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktMeta">+</span><span class="hspace">&nbsp;</span><span class="RktMeta">cookie</span><span class="hspace">&nbsp;</span><span class="RktMeta">v2</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktMeta"></span></td></tr></table></blockquote></div></p><p><div class="SIntrapara"><span style="font-weight: bold">Exercise</span></div><div class="SIntrapara"><blockquote><p>What do we <span style="font-style: italic">expect</span> for the same sequence as before?</p></blockquote></div></p><p><div class="SIntrapara"><span style="font-weight: bold">Do Now!</span></div><div class="SIntrapara"><blockquote><p>What happens?</p></blockquote></div></p><p><div class="SIntrapara">Initially, nothing seems different:
</div><div class="SIntrapara"><table cellspacing="0" cellpadding="0"><tr><td><p><span class="stt">First number To enter it, use the action field label 1</span></p></td></tr><tr><td><p><span class="stt">&gt; (resume 1 3)</span></p></td></tr><tr><td><p><span class="stt">Second number To enter it, use the action field label 2</span></p></td></tr><tr><td><p><span class="stt">&gt; (resume 2 10)</span></p></td></tr><tr><td><p><span class="stt">13</span></p></td></tr></table></div><div class="SIntrapara">When we reuse the initial computation, we indeed get a new resumption
label:
</div><div class="SIntrapara"><table cellspacing="0" cellpadding="0"><tr><td><p><span class="stt">&gt; (resume 1 5)</span></p></td></tr><tr><td><p><span class="stt">Second number To enter it, use the action field label 3</span></p></td></tr></table></div><div class="SIntrapara">which, when used, computes what we&rsquo;d expect:
</div><div class="SIntrapara"><table cellspacing="0" cellpadding="0"><tr><td><p><span class="stt">&gt; (resume 3 10)</span></p></td></tr><tr><td><p><span class="stt">15</span></p></td></tr></table></div><div class="SIntrapara">Now we come to the critical step:
</div><div class="SIntrapara"><table cellspacing="0" cellpadding="0"><tr><td><p><span class="stt">&gt; (resume 2 10)</span></p></td></tr><tr><td><p><span class="stt">15</span></p></td></tr></table></div><div class="SIntrapara">It is unsurprising that the two resumptions of label <span class="stt">2</span> would
produce different answers, given that they rely on mutable state.  The
reason it&rsquo;s problematic is because of what happens when we translate
the same behavior to the Web.</div></p><p>Imagine visiting a hotel reservation Web site and searching for hotels
in a city.  In return, you are shown a list of hotels and the label
<span class="stt">1</span>.  You explore one of them in a new tab or window; this
produces information on that hotel, and label <span class="stt">2</span> to make the
reservation.  You decide, however, to return to the hotel listing and
explore another hotel in a fresh tab or window.  This produces the
second hotel&rsquo;s information, with label <span class="stt">3</span> to reserve at that
hotel.  You decide, however, to choose the first hotel, return to the
first hotel&rsquo;s page, and choose its reservation button&#8212;<wbr></wbr>i.e., submit
label <span class="stt">2</span>.  Which hotel did you expect to be booked into?  Though
you expected a reservation at the <span style="font-style: italic">first</span> hotel, on most travel
sites, this will either reserve at the <span style="font-style: italic">second</span> hotel&#8212;<wbr></wbr>i.e., the
one you last viewed, but not the one on the page whose reservation
button you clicked&#8212;<wbr></wbr>or produce an error.  This is because of the
pervasive use of cookies on Web sites, a practice encouraged by most
Web <span class="Smaller">API</span>s.</p><h4>14.2<tt>&nbsp;</tt><a name="(part._.Continuation-.Passing_.Style)"></a>Continuation-Passing Style</h4><p>The functions we&rsquo;ve been writing have a name.  Though we&rsquo;ve presented
ideas in terms of the Web, we&rsquo;re relying on a much older idea: the
functions are called <span style="font-style: italic">continuations</span>, and this style of programs
is called <span style="font-style: italic">continuation-passing style</span> (<span class="Smaller">CPS</span>).<span class="refelem"><span class="refcolumn"><span class="refcontent">We
will take the liberty of using <span class="Smaller">CPS</span> as both a noun and verb: a
particular structure of code and the process that converts code into
it.</span></span></span>  This is worth studying in its own right, because it is the basis
for studying a variety of other non-trivial control operations&#8212;<wbr></wbr>such
as generators.</p><p>Earlier, we converted programs so that no Web input operation was
nested inside another.  The motivation was simple: when the program
terminates, all nested computations are lost.  A similar argument
applies, in a more local sense, in the case of <span class="stt">XMLHttpRequest</span>:
any computation depending on the result of a response from a Web
server needs to reside in the callback associated with the request to
the server.</p><p>In fact, we don&rsquo;t need to transform <span style="font-style: italic">every</span> expression.  We only
care about expressions that involve actual Web interaction.  For
example, if we computed a more complex mathematical expression than
just addition, we wouldn&rsquo;t need to transform it.  If, however, we had
a function call, we&rsquo;d either have to be absolutely certain the
function didn&rsquo;t have any Web invocations either inside it, or in the
functions in invokes, or the ones <span style="font-style: italic">they</span> invoke...or else, to be
defensive, we should transform them all.  Therefore, we have to
transform every expression that we can&rsquo;t be sure performs no Web
interactions.</p><p>The heart of our transformation is therefore to turn every
one-argument function, <span class="stt">f</span>, into one with an extra argument.
This extra argument is the continuation, which represents the rest of
the computation.  The continuation is itself a function of one
argument.  This argument takes the value that <span style="font-style: italic">would have been
returned</span> by <span class="stt">f</span> and passes it to the rest of the computation.
<span class="stt">f</span>, instead of <span style="font-style: italic">returning</span> a value, instead <span style="font-style: italic">passes</span>
the value it would have returned to its continuation.</p><p><span class="Smaller">CPS</span> is a general transformation, which we can apply to any program.
Because it&rsquo;s a program transformation, we can think of it as a special
kind of desugaring: in particular, instead of transforming programs
from a larger language to a smaller one (as macros do), or from one
language to entirely another (as compilers do), it transforms programs
<span style="font-style: italic">within</span> the same language: from the full language to a more
restricted version that obeys the pattern we&rsquo;ve been discussing.  As a
result, we can reuse an evaluator for the full language to also
evaluate programs in the <span class="Smaller">CPS</span> subset.</p><h5>14.2.1<tt>&nbsp;</tt><a name="(part._.Implementation_by_.Desugaring)"></a>Implementation by Desugaring</h5><p>Because we already have good support for desugaring, let&rsquo;s use to
define the <span class="Smaller">CPS</span> transform.  Concretely, we&rsquo;ll implement a <span class="Smaller">CPS</span> macro
[REF].
To more cleanly separate the source language from the
target, we&rsquo;ll use slightly different names for most of the language
constructs: a one-armed <span class="stt">with</span> and <span class="stt">rec</span> instead of
<span class="stt">let</span> and <span class="stt">letrec</span>; <span class="stt">lam</span> instead of <span class="stt">lambda</span>;
<span class="stt">cnd</span> instead of <span class="stt">if</span>; <span class="stt">seq</span> for <span class="stt">begin</span>; and
<span class="stt">set</span> for <span class="stt">set!</span>.  We&rsquo;ll also give ourselves a sufficiently
rich language to write some interesting programs!<span class="refelem"><span class="refcolumn"><span class="refcontent">The
presentation that follows orders the cases of the macro from what I
believe are easiest to hardest.  However, the code in the macro must
avoid non-overlapping patterns, and hence follows a diffent order.</span></span></span></p><p><div class="SIntrapara"><a name="(elem._(chunk._~3ccps-macro~3e~3a1))"></a><span style="font-weight: bold"><span style="font-style: italic"><a href="#%28elem._%28chunk._~3ccps-macro~3e~3a1%29%29" class="plainlink" data-pltdoc="x">&lt;cps-macro&gt;</a></span> ::=</span></div><div class="SIntrapara"><blockquote class="SCodeFlow"><table cellspacing="0" cellpadding="0" class="RktBlk"><tr><td><span class="RktPn">(</span><span class="RktSym">define-syntax</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">cps</span><span class="hspace">&nbsp;</span><span class="RktSym">e</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym">syntax-case</span><span class="hspace">&nbsp;</span><span class="RktSym">e</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">with</span><span class="hspace">&nbsp;</span><span class="RktSym">rec</span><span class="hspace">&nbsp;</span><span class="RktSym">lam</span><span class="hspace">&nbsp;</span><span class="RktSym">cnd</span><span class="hspace">&nbsp;</span><span class="RktSym">seq</span><span class="hspace">&nbsp;</span><span class="RktSym">set</span><span class="hspace">&nbsp;</span><span class="RktSym">quote</span><span class="hspace">&nbsp;</span><span class="RktSym">display</span><span class="hspace">&nbsp;</span><span class="RktSym">read-number</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;</span><a href="#%28elem._%28chunk._~3ccps-macro-with-case~3e~3a1%29%29" class="plainlink" data-pltdoc="x">&lt;cps-macro-with-case&gt;</a></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;</span><a href="#%28elem._%28chunk._~3ccps-macro-rec-case~3e~3a1%29%29" class="plainlink" data-pltdoc="x">&lt;cps-macro-rec-case&gt;</a></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;</span><a href="#%28elem._%28chunk._~3ccps-macro-lam-case~3e~3a1%29%29" class="plainlink" data-pltdoc="x">&lt;cps-macro-lam-case&gt;</a></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;</span><a href="#%28elem._%28chunk._~3ccps-macro-cnd-case~3e~3a1%29%29" class="plainlink" data-pltdoc="x">&lt;cps-macro-cnd-case&gt;</a></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;</span><a href="#%28elem._%28chunk._~3ccps-macro-display-case~3e~3a1%29%29" class="plainlink" data-pltdoc="x">&lt;cps-macro-display-case&gt;</a></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;</span><a href="#%28elem._%28chunk._~3ccps-macro-read-number-case~3e~3a1%29%29" class="plainlink" data-pltdoc="x">&lt;cps-macro-read-number-case&gt;</a></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;</span><a href="#%28elem._%28chunk._~3ccps-macro-seq-case~3e~3a1%29%29" class="plainlink" data-pltdoc="x">&lt;cps-macro-seq-case&gt;</a></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;</span><a href="#%28elem._%28chunk._~3ccps-macro-set-case~3e~3a1%29%29" class="plainlink" data-pltdoc="x">&lt;cps-macro-set-case&gt;</a></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;</span><a href="#%28elem._%28chunk._~3ccps-macro-quote-case~3e~3a1%29%29" class="plainlink" data-pltdoc="x">&lt;cps-macro-quote-case&gt;</a></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;</span><a href="#%28elem._%28chunk._~3ccps-macro-app-1-case~3e~3a1%29%29" class="plainlink" data-pltdoc="x">&lt;cps-macro-app-1-case&gt;</a></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;</span><a href="#%28elem._%28chunk._~3ccps-macro-app-2-case~3e~3a1%29%29" class="plainlink" data-pltdoc="x">&lt;cps-macro-app-2-case&gt;</a></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;</span><a href="#%28elem._%28chunk._~3ccps-macro-atomic-case~3e~3a1%29%29" class="plainlink" data-pltdoc="x">&lt;cps-macro-atomic-case&gt;</a><span class="RktPn">)</span><span class="RktPn">)</span></td></tr></table></blockquote></div></p><p>Our representation in <span class="Smaller">CPS</span> will be to turn <span style="font-style: italic">every</span> expression
into a procedure of one argument, the continuation.  The converted
expression will eventually either supply a value to the continuation
or will pass the continuation on to some other expression that
will&#8212;<wbr></wbr>by preserving this invariant inductively&#8212;<wbr></wbr>supply it with a
value.  Thus, all output from <span class="Smaller">CPS</span> will look like
<span class="stt">(lambda (k) ...)</span> (and we will rely on hygiene [REF] to keep all
these introduced <span class="stt">k</span>&rsquo;s from clashing with one another).</p><p>First let&rsquo;s dispatch with the easy case, which is atomic values.
Though conceptually easiest, we have written this last because
otherwise this pattern would shadow all the other cases.  (Ideally, we
should have written it first and provided a guard expression that
precisely defines the syntactic cases we want to treat as atomic.
We&rsquo;re playing loose here becuase our focus is on more interesting
cases.)  In the atomic case, we already have a value, so we simply
need to supply it to the continuation:</p><p><div class="SIntrapara"><a name="(elem._(chunk._~3ccps-macro-atomic-case~3e~3a1))"></a><span style="font-weight: bold"><span style="font-style: italic"><a href="#%28elem._%28chunk._~3ccps-macro-atomic-case~3e~3a1%29%29" class="plainlink" data-pltdoc="x">&lt;cps-macro-atomic-case&gt;</a></span> ::=</span></div><div class="SIntrapara"><blockquote class="SCodeFlow"><table cellspacing="0" cellpadding="0" class="RktBlk"><tr><td><span class="RktPn">[</span><span class="RktPn">(</span><span class="RktSym">_</span><span class="hspace">&nbsp;</span><span class="RktSym">atomic</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;</span><span class="RktRdr">#'</span><span class="RktPn">(</span><span class="RktSym">lambda</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">k</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym">k</span><span class="hspace">&nbsp;</span><span class="RktSym">atomic</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">]</span></td></tr></table></blockquote></div></p><p>Similarly for quoted constants:</p><p><div class="SIntrapara"><a name="(elem._(chunk._~3ccps-macro-quote-case~3e~3a1))"></a><span style="font-weight: bold"><span style="font-style: italic"><a href="#%28elem._%28chunk._~3ccps-macro-quote-case~3e~3a1%29%29" class="plainlink" data-pltdoc="x">&lt;cps-macro-quote-case&gt;</a></span> ::=</span></div><div class="SIntrapara"><blockquote class="SCodeFlow"><table cellspacing="0" cellpadding="0" class="RktBlk"><tr><td><span class="RktPn">[</span><span class="RktPn">(</span><span class="RktSym">_</span><span class="hspace">&nbsp;</span><span class="RktVal">'</span><span class="RktVal">e</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;</span><span class="RktRdr">#'</span><span class="RktPn">(</span><span class="RktSym">lambda</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">k</span><span class="RktPn">)</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">k</span><span class="hspace">&nbsp;</span><span class="RktVal">'</span><span class="RktVal">e</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">]</span></td></tr></table></blockquote></div></p><p>Also, we already know, from [REF] and [REF], that we can treat
<span class="stt">with</span> and <span class="stt">rec</span> as macros, respectively:</p><p><div class="SIntrapara"><a name="(elem._(chunk._~3ccps-macro-with-case~3e~3a1))"></a><span style="font-weight: bold"><span style="font-style: italic"><a href="#%28elem._%28chunk._~3ccps-macro-with-case~3e~3a1%29%29" class="plainlink" data-pltdoc="x">&lt;cps-macro-with-case&gt;</a></span> ::=</span></div><div class="SIntrapara"><blockquote class="SCodeFlow"><table cellspacing="0" cellpadding="0" class="RktBlk"><tr><td><span class="RktPn">[</span><span class="RktPn">(</span><span class="RktSym">_</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">with</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">v</span><span class="hspace">&nbsp;</span><span class="RktSym">e</span><span class="RktPn">)</span><span class="hspace">&nbsp;</span><span class="RktSym">b</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;</span><span class="RktRdr">#'</span><span class="RktPn">(</span><span class="RktSym">cps</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktPn">(</span><span class="RktSym">lam</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">v</span><span class="RktPn">)</span><span class="hspace">&nbsp;</span><span class="RktSym">b</span><span class="RktPn">)</span><span class="hspace">&nbsp;</span><span class="RktSym">e</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">]</span></td></tr></table></blockquote></div></p><p><div class="SIntrapara"><a name="(elem._(chunk._~3ccps-macro-rec-case~3e~3a1))"></a><span style="font-weight: bold"><span style="font-style: italic"><a href="#%28elem._%28chunk._~3ccps-macro-rec-case~3e~3a1%29%29" class="plainlink" data-pltdoc="x">&lt;cps-macro-rec-case&gt;</a></span> ::=</span></div><div class="SIntrapara"><blockquote class="SCodeFlow"><table cellspacing="0" cellpadding="0" class="RktBlk"><tr><td><span class="RktPn">[</span><span class="RktPn">(</span><span class="RktSym">_</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">rec</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">v</span><span class="hspace">&nbsp;</span><span class="RktSym">f</span><span class="RktPn">)</span><span class="hspace">&nbsp;</span><span class="RktSym">b</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;</span><span class="RktRdr">#'</span><span class="RktPn">(</span><span class="RktSym">cps</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">with</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">v</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">lam</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">arg</span><span class="RktPn">)</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">error</span><span class="hspace">&nbsp;</span><span class="RktVal">'</span><span class="RktVal">dummy</span><span class="hspace">&nbsp;</span><span class="RktVal">"nothing"</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym">seq</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym">set</span><span class="hspace">&nbsp;</span><span class="RktSym">v</span><span class="hspace">&nbsp;</span><span class="RktSym">f</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktSym">b</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">]</span></td></tr></table></blockquote></div></p><p>Mutation is easy: we have to evaluate the new value, and then perform
the actual update:</p><p><div class="SIntrapara"><a name="(elem._(chunk._~3ccps-macro-set-case~3e~3a1))"></a><span style="font-weight: bold"><span style="font-style: italic"><a href="#%28elem._%28chunk._~3ccps-macro-set-case~3e~3a1%29%29" class="plainlink" data-pltdoc="x">&lt;cps-macro-set-case&gt;</a></span> ::=</span></div><div class="SIntrapara"><blockquote class="SCodeFlow"><table cellspacing="0" cellpadding="0" class="RktBlk"><tr><td><span class="RktPn">[</span><span class="RktPn">(</span><span class="RktSym">_</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">set</span><span class="hspace">&nbsp;</span><span class="RktSym">v</span><span class="hspace">&nbsp;</span><span class="RktSym">e</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;</span><span class="RktRdr">#'</span><span class="RktPn">(</span><span class="RktSym">lambda</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">k</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktPn">(</span><span class="RktSym">cps</span><span class="hspace">&nbsp;</span><span class="RktSym">e</span><span class="RktPn">)</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">lambda</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">ev</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym">k</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">set!</span><span class="hspace">&nbsp;</span><span class="RktSym">v</span><span class="hspace">&nbsp;</span><span class="RktSym">ev</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">]</span></td></tr></table></blockquote></div></p><p>Sequencing is also straightforward: we perform each operation in turn.
Observe how this preserves the semantics of sequencing: not only does
it obey the order of operations, the value of the first sub-term
(<span class="stt">e1</span>) is not mentioned anywhere in the body of the second
(<span class="stt">e2</span>), so the name given to the identifier holding its value is
irrelevant.</p><p><div class="SIntrapara"><a name="(elem._(chunk._~3ccps-macro-seq-case~3e~3a1))"></a><span style="font-weight: bold"><span style="font-style: italic"><a href="#%28elem._%28chunk._~3ccps-macro-seq-case~3e~3a1%29%29" class="plainlink" data-pltdoc="x">&lt;cps-macro-seq-case&gt;</a></span> ::=</span></div><div class="SIntrapara"><blockquote class="SCodeFlow"><table cellspacing="0" cellpadding="0" class="RktBlk"><tr><td><span class="RktPn">[</span><span class="RktPn">(</span><span class="RktSym">_</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">seq</span><span class="hspace">&nbsp;</span><span class="RktSym">e1</span><span class="hspace">&nbsp;</span><span class="RktSym">e2</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;</span><span class="RktRdr">#'</span><span class="RktPn">(</span><span class="RktSym">lambda</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">k</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktPn">(</span><span class="RktSym">cps</span><span class="hspace">&nbsp;</span><span class="RktSym">e1</span><span class="RktPn">)</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">lambda</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">_</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktPn">(</span><span class="RktSym">cps</span><span class="hspace">&nbsp;</span><span class="RktSym">e2</span><span class="RktPn">)</span><span class="hspace">&nbsp;</span><span class="RktSym">k</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">]</span></td></tr></table></blockquote></div></p><p>When handling conditionals, we need to create a new continuation to
remember that we are waiting for the test expression to evaluate.
Once we have its value, however, we can dispatch on the result and
return to the existing continuations:</p><p><div class="SIntrapara"><a name="(elem._(chunk._~3ccps-macro-cnd-case~3e~3a1))"></a><span style="font-weight: bold"><span style="font-style: italic"><a href="#%28elem._%28chunk._~3ccps-macro-cnd-case~3e~3a1%29%29" class="plainlink" data-pltdoc="x">&lt;cps-macro-cnd-case&gt;</a></span> ::=</span></div><div class="SIntrapara"><blockquote class="SCodeFlow"><table cellspacing="0" cellpadding="0" class="RktBlk"><tr><td><span class="RktPn">[</span><span class="RktPn">(</span><span class="RktSym">_</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">cnd</span><span class="hspace">&nbsp;</span><span class="RktSym">tst</span><span class="hspace">&nbsp;</span><span class="RktSym">thn</span><span class="hspace">&nbsp;</span><span class="RktSym">els</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;</span><span class="RktRdr">#'</span><span class="RktPn">(</span><span class="RktSym">lambda</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">k</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktPn">(</span><span class="RktSym">cps</span><span class="hspace">&nbsp;</span><span class="RktSym">tst</span><span class="RktPn">)</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">lambda</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">tstv</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym">if</span><span class="hspace">&nbsp;</span><span class="RktSym">tstv</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktPn">(</span><span class="RktSym">cps</span><span class="hspace">&nbsp;</span><span class="RktSym">thn</span><span class="RktPn">)</span><span class="hspace">&nbsp;</span><span class="RktSym">k</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktPn">(</span><span class="RktSym">cps</span><span class="hspace">&nbsp;</span><span class="RktSym">els</span><span class="RktPn">)</span><span class="hspace">&nbsp;</span><span class="RktSym">k</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">]</span></td></tr></table></blockquote></div></p><p>When we get to applications, we have two cases to consider.  We
absolutely need to handle the treatment of procedures created in the
language: those with one argument.  For the purposes of writing
example programs, however, it is useful to be able to employ
primitives such as <span class="stt">+</span> and <span class="stt">*</span>.  Thus, we will <span style="font-style: italic">assume
for simplicity</span> that one-argument procedures are written by the user,
and hence need conversion to <span class="Smaller">CPS</span>, while two-argument ones are
primitives that will not perform any Web or other control operations
and hence can be invoked directly; we will <span style="font-style: italic">also</span> assume that the
primitive will be written in-line (i.e., the application position will
not be a complex expression that can itself, say, perform a Web
interaction).</p><p>For an application we have to evaluate both the function and argument
expressions.  Once we&rsquo;ve obtained these, we are ready to apply the
function.  Therefore, it is tempting to write</p><p><div class="SIntrapara"><a name="(elem._(chunk._~3ccps-macro-app-1-case-take-1~3e~3a1))"></a><span style="font-weight: bold"><span style="font-style: italic"><a href="#%28elem._%28chunk._~3ccps-macro-app-1-case-take-1~3e~3a1%29%29" class="plainlink" data-pltdoc="x">&lt;cps-macro-app-1-case-take-1&gt;</a></span> ::=</span></div><div class="SIntrapara"><blockquote class="SCodeFlow"><table cellspacing="0" cellpadding="0" class="RktBlk"><tr><td><span class="RktPn">[</span><span class="RktPn">(</span><span class="RktSym">_</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">f</span><span class="hspace">&nbsp;</span><span class="RktSym">a</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;</span><span class="RktRdr">#'</span><span class="RktPn">(</span><span class="RktSym">lambda</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">k</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktPn">(</span><span class="RktSym">cps</span><span class="hspace">&nbsp;</span><span class="RktSym">f</span><span class="RktPn">)</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">lambda</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">fv</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktPn">(</span><span class="RktSym">cps</span><span class="hspace">&nbsp;</span><span class="RktSym">a</span><span class="RktPn">)</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">lambda</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">av</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym">k</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">fv</span><span class="hspace">&nbsp;</span><span class="RktSym">av</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">]</span></td></tr></table></blockquote></div></p><p><div class="SIntrapara"><span style="font-weight: bold">Do Now!</span></div><div class="SIntrapara"><blockquote><p>Do you see why this is wrong?</p></blockquote></div></p><p>The problem is that, though the function is now a value, that value is
a closure with a potentially complicated body: evaluating the body
can, for example, result in further Web interactions, at which point
the rest of the function&rsquo;s body, as well as the pending
<span class="stt">(k ...)</span> (i.e., the rest of the program), will all be lost.  To
avoid this, we have to supply <span class="stt">k</span> to the function&rsquo;s value, and
let the inductive invariant ensure that <span class="stt">k</span> will eventually be
invoked with the value of applying <span class="stt">fv</span> to <span class="stt">av</span>:</p><p><div class="SIntrapara"><a name="(elem._(chunk._~3ccps-macro-app-1-case~3e~3a1))"></a><span style="font-weight: bold"><span style="font-style: italic"><a href="#%28elem._%28chunk._~3ccps-macro-app-1-case~3e~3a1%29%29" class="plainlink" data-pltdoc="x">&lt;cps-macro-app-1-case&gt;</a></span> ::=</span></div><div class="SIntrapara"><blockquote class="SCodeFlow"><table cellspacing="0" cellpadding="0" class="RktBlk"><tr><td><span class="RktPn">[</span><span class="RktPn">(</span><span class="RktSym">_</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">f</span><span class="hspace">&nbsp;</span><span class="RktSym">a</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;</span><span class="RktRdr">#'</span><span class="RktPn">(</span><span class="RktSym">lambda</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">k</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktPn">(</span><span class="RktSym">cps</span><span class="hspace">&nbsp;</span><span class="RktSym">f</span><span class="RktPn">)</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">lambda</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">fv</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktPn">(</span><span class="RktSym">cps</span><span class="hspace">&nbsp;</span><span class="RktSym">a</span><span class="RktPn">)</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">lambda</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">av</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym">fv</span><span class="hspace">&nbsp;</span><span class="RktSym">av</span><span class="hspace">&nbsp;</span><span class="RktSym">k</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">]</span></td></tr></table></blockquote></div></p><p>Treating the special case of built-in binary operations is easier:</p><p><div class="SIntrapara"><a name="(elem._(chunk._~3ccps-macro-app-2-case~3e~3a1))"></a><span style="font-weight: bold"><span style="font-style: italic"><a href="#%28elem._%28chunk._~3ccps-macro-app-2-case~3e~3a1%29%29" class="plainlink" data-pltdoc="x">&lt;cps-macro-app-2-case&gt;</a></span> ::=</span></div><div class="SIntrapara"><blockquote class="SCodeFlow"><table cellspacing="0" cellpadding="0" class="RktBlk"><tr><td><span class="RktPn">[</span><span class="RktPn">(</span><span class="RktSym">_</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">f</span><span class="hspace">&nbsp;</span><span class="RktSym">a</span><span class="hspace">&nbsp;</span><span class="RktSym">b</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;</span><span class="RktRdr">#'</span><span class="RktPn">(</span><span class="RktSym">lambda</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">k</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktPn">(</span><span class="RktSym">cps</span><span class="hspace">&nbsp;</span><span class="RktSym">a</span><span class="RktPn">)</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">lambda</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">av</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktPn">(</span><span class="RktSym">cps</span><span class="hspace">&nbsp;</span><span class="RktSym">b</span><span class="RktPn">)</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">lambda</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">bv</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym">k</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">f</span><span class="hspace">&nbsp;</span><span class="RktSym">av</span><span class="hspace">&nbsp;</span><span class="RktSym">bv</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">]</span></td></tr></table></blockquote></div></p><p>The very pattern we could not use for user-defined procedures we
employ here, because we assume that the application of <span class="stt">f</span> will
always return without any unusual transfers of control.</p><p>A function is itself a value, so it should be returned to the pending
computation.  The application case above, however, shows that we have
to transform functions to take an extra argument, namely the
continuation at the point of invocation.  This leaves us with a
quandary: which continuation do we supply to the body?</p><p><div class="SIntrapara"><a name="(elem._(chunk._~3ccps-macro-lam-case-take-1~3e~3a1))"></a><span style="font-weight: bold"><span style="font-style: italic"><a href="#%28elem._%28chunk._~3ccps-macro-lam-case-take-1~3e~3a1%29%29" class="plainlink" data-pltdoc="x">&lt;cps-macro-lam-case-take-1&gt;</a></span> ::=</span></div><div class="SIntrapara"><blockquote class="SCodeFlow"><table cellspacing="0" cellpadding="0" class="RktBlk"><tr><td><span class="RktPn">[</span><span class="RktPn">(</span><span class="RktSym">_</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">lam</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">a</span><span class="RktPn">)</span><span class="hspace">&nbsp;</span><span class="RktSym">b</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">identifier?</span><span class="hspace">&nbsp;</span><span class="RktRdr">#'</span><span class="RktSym">a</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;</span><span class="RktRdr">#'</span><span class="RktPn">(</span><span class="RktSym">lambda</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">k</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym">k</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">lambda</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">a</span><span class="hspace">&nbsp;</span><span class="RktSym">dyn-k</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktPn">(</span><span class="RktSym">cps</span><span class="hspace">&nbsp;</span><span class="RktSym">b</span><span class="RktPn">)</span><span class="hspace">&nbsp;</span><span class="RktSym">...</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">]</span></td></tr></table></blockquote></div></p><p>That is, in place of <span class="stt">...</span>, which continuation do we supply:
<span class="stt">k</span> or <span class="stt">dyn-k</span>?</p><p><div class="SIntrapara"><span style="font-weight: bold">Do Now!</span></div><div class="SIntrapara"><blockquote><p>Which continuation should we supply?</p></blockquote></div></p><p>The former is the continuation <span style="font-style: italic">at the point of closure
creation</span>.  The latter is the continuation <span style="font-style: italic">at the point of
closure invocation</span>.  In other words, the former is &ldquo;static&rdquo; and the
latter is &ldquo;dynamic&rdquo;.  In this case, we need to use the dynamic
continuation, otherwise something very strange would happen: the
program would return to the point where the closure was created,
rather than where it is being used!  This would result in seemingly
very strange program behavior, so we wish to avoid it.  Observe that
we are consciously choosing the dynamic continuation just as, where
scope was concerned, we chose the static environment.</p><p><div class="SIntrapara"><a name="(elem._(chunk._~3ccps-macro-lam-case~3e~3a1))"></a><span style="font-weight: bold"><span style="font-style: italic"><a href="#%28elem._%28chunk._~3ccps-macro-lam-case~3e~3a1%29%29" class="plainlink" data-pltdoc="x">&lt;cps-macro-lam-case&gt;</a></span> ::=</span></div><div class="SIntrapara"><blockquote class="SCodeFlow"><table cellspacing="0" cellpadding="0" class="RktBlk"><tr><td><span class="RktPn">[</span><span class="RktPn">(</span><span class="RktSym">_</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">lam</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">a</span><span class="RktPn">)</span><span class="hspace">&nbsp;</span><span class="RktSym">b</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">identifier?</span><span class="hspace">&nbsp;</span><span class="RktRdr">#'</span><span class="RktSym">a</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;</span><span class="RktRdr">#'</span><span class="RktPn">(</span><span class="RktSym">lambda</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">k</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym">k</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">lambda</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">a</span><span class="hspace">&nbsp;</span><span class="RktSym">dyn-k</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktPn">(</span><span class="RktSym">cps</span><span class="hspace">&nbsp;</span><span class="RktSym">b</span><span class="RktPn">)</span><span class="hspace">&nbsp;</span><span class="RktSym">dyn-k</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">]</span></td></tr></table></blockquote></div></p><p>Finally, for the purpose of modeling Web programming, we can add our
input and output procedures.  Output follows the application pattern
we&rsquo;ve already seen:</p><p><div class="SIntrapara"><a name="(elem._(chunk._~3ccps-macro-display-case~3e~3a1))"></a><span style="font-weight: bold"><span style="font-style: italic"><a href="#%28elem._%28chunk._~3ccps-macro-display-case~3e~3a1%29%29" class="plainlink" data-pltdoc="x">&lt;cps-macro-display-case&gt;</a></span> ::=</span></div><div class="SIntrapara"><blockquote class="SCodeFlow"><table cellspacing="0" cellpadding="0" class="RktBlk"><tr><td><span class="RktPn">[</span><span class="RktPn">(</span><span class="RktSym">_</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">display</span><span class="hspace">&nbsp;</span><span class="RktSym">output</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;</span><span class="RktRdr">#'</span><span class="RktPn">(</span><span class="RktSym">lambda</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">k</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktPn">(</span><span class="RktSym">cps</span><span class="hspace">&nbsp;</span><span class="RktSym">output</span><span class="RktPn">)</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">lambda</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">ov</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym">k</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">display</span><span class="hspace">&nbsp;</span><span class="RktSym">ov</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">]</span></td></tr></table></blockquote></div></p><p>Finally, for input, we can use the pre-existing
<span class="stt">read-number/suspend</span>, but this time <span style="font-style: italic">generate</span> its uses
rather than force the programmer to construct them:</p><p><div class="SIntrapara"><a name="(elem._(chunk._~3ccps-macro-read-number-case~3e~3a1))"></a><span style="font-weight: bold"><span style="font-style: italic"><a href="#%28elem._%28chunk._~3ccps-macro-read-number-case~3e~3a1%29%29" class="plainlink" data-pltdoc="x">&lt;cps-macro-read-number-case&gt;</a></span> ::=</span></div><div class="SIntrapara"><blockquote class="SCodeFlow"><table cellspacing="0" cellpadding="0" class="RktBlk"><tr><td><span class="RktPn">[</span><span class="RktPn">(</span><span class="RktSym">_</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">read-number</span><span class="hspace">&nbsp;</span><span class="RktSym">prompt</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;</span><span class="RktRdr">#'</span><span class="RktPn">(</span><span class="RktSym">lambda</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">k</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktPn">(</span><span class="RktSym">cps</span><span class="hspace">&nbsp;</span><span class="RktSym">prompt</span><span class="RktPn">)</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">lambda</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">pv</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym">read-number/suspend</span><span class="hspace">&nbsp;</span><span class="RktSym">pv</span><span class="hspace">&nbsp;</span><span class="RktSym">k</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">]</span></td></tr></table></blockquote></div></p><p>Notice that the continuation bound to <span class="stt">k</span> is precisely the
continuation that we need to stash at the point of a Web interaction.</p><p><div class="SIntrapara">Testing any code converted to <span class="Smaller">CPS</span> is slightly annoying because all
<span class="Smaller">CPS</span> terms expect a continuation.  The initial continuation is one
that simply either (a) consumes a value and returns it, or (b)
consumes a value and prints it, or (c) consumes a value, prints it,
and gets ready for another computation (as the prompt in the DrRacket
Interactions window does).  All three of these are effectively just
the identity function in various guises.  Thus, the following
definition is helpful for testing:
</div><div class="SIntrapara"><blockquote class="SCodeFlow"><table cellspacing="0" cellpadding="0" class="RktBlk"><tr><td><span class="RktPn">(</span><span class="RktMeta">define</span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktMeta">run</span><span class="hspace">&nbsp;</span><span class="RktMeta">c</span><span class="RktPn">)</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktMeta">c</span><span class="hspace">&nbsp;</span><span class="RktMeta">identity</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktMeta"></span></td></tr></table></blockquote></div><div class="SIntrapara">For instance,
</div><div class="SIntrapara"><blockquote class="SCodeFlow"><table cellspacing="0" cellpadding="0" class="RktBlk"><tr><td><span class="RktPn">(</span><span class="RktMeta">test</span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktMeta">run</span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktMeta">cps</span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktVal">3</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktVal">3</span><span class="RktPn">)</span><span class="RktMeta"></span></td></tr><tr><td><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktMeta">test</span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktMeta">run</span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktMeta">cps</span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktPn">(</span><span class="RktMeta">lam</span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktPn">)</span><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktVal">5</span><span class="RktPn">)</span><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktVal">5</span><span class="RktPn">)</span><span class="RktMeta"></span></td></tr><tr><td><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktMeta">test</span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktMeta">run</span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktMeta">cps</span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktPn">(</span><span class="RktMeta">lam</span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktMeta">x</span><span class="RktPn">)</span><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktMeta">*</span><span class="hspace">&nbsp;</span><span class="RktMeta">x</span><span class="hspace">&nbsp;</span><span class="RktMeta">x</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktVal">5</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktVal">25</span><span class="RktPn">)</span><span class="RktMeta"></span></td></tr><tr><td><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktMeta">test</span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktMeta">run</span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktMeta">cps</span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktMeta">+</span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktVal">5</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktPn">(</span><span class="RktMeta">lam</span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktMeta">x</span><span class="RktPn">)</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktMeta">*</span><span class="hspace">&nbsp;</span><span class="RktMeta">x</span><span class="hspace">&nbsp;</span><span class="RktMeta">x</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktVal">5</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktVal">30</span><span class="RktPn">)</span><span class="RktMeta"></span></td></tr></table></blockquote></div><div class="SIntrapara">We can also test our old Web program:
</div><div class="SIntrapara"><blockquote class="SCodeFlow"><table cellspacing="0" cellpadding="0" class="RktBlk"><tr><td><span class="RktPn">(</span><span class="RktMeta">run</span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktMeta">cps</span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktMeta">display</span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktMeta">+</span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktMeta">read-number</span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktVal">"First"</span><span class="RktPn">)</span><span class="RktMeta"></span></td></tr><tr><td><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktMeta">read-number</span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktVal">"Second"</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktMeta"></span></td></tr></table></blockquote></div></p><p>Lest you get lost in the myriad of code, let me highlight the
important lesson here: <span style="font-style: italic">We&rsquo;ve recovered our code structure</span>.
That is, we can write the program in <span style="font-style: italic">direct style</span>, with properly
nested expressions, and a compiler&#8212;<wbr></wbr>in this case, the <span class="Smaller">CPS</span>
converter&#8212;<wbr></wbr>takes care of making it work with a suitable underlying
<span class="Smaller">API</span>.  This is what good programming languages ought to do!</p><h5>14.2.2<tt>&nbsp;</tt><a name="(part._.Converting_the_.Example)"></a>Converting the Example</h5><p><div class="SIntrapara">Let&rsquo;s consider the example above and see what it converts to.  You
can either do this by hand, or take the easy way out and employ the
Macro Stepper of DrRacket.<span class="refelem"><span class="refcolumn"><span class="refcontent">For now, you need to put the
code in <span class="stt">#lang racket</span> to get the full force of the Macro
Stepper.</span></span></span>  Assuming we include the application to <span class="stt">identity</span>
contained in <span class="stt">run</span>, we get:
</div><div class="SIntrapara"><blockquote class="SCodeFlow"><table cellspacing="0" cellpadding="0" class="RktBlk"><tr><td><span class="RktPn">(</span><span class="RktMeta">lambda</span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktMeta">k</span><span class="RktPn">)</span><span class="RktMeta"></span></td></tr><tr><td><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktPn">(</span><span class="RktMeta">lambda</span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktMeta">k</span><span class="RktPn">)</span><span class="RktMeta"></span></td></tr><tr><td><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktPn">(</span><span class="RktMeta">lambda</span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktMeta">k</span><span class="RktPn">)</span><span class="RktMeta"></span></td></tr><tr><td><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktPn">(</span><span class="RktMeta">lambda</span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktMeta">k</span><span class="RktPn">)</span><span class="RktMeta"></span></td></tr><tr><td><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktMeta">k</span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktVal">"First"</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktMeta">lambda</span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktMeta">pv</span><span class="RktPn">)</span><span class="RktMeta"></span></td></tr><tr><td><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktMeta">read-number/suspend</span><span class="hspace">&nbsp;</span><span class="RktMeta">pv</span><span class="hspace">&nbsp;</span><span class="RktMeta">k</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktMeta"></span></td></tr><tr><td><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktMeta">lambda</span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktMeta">lv</span><span class="RktPn">)</span><span class="RktMeta"></span></td></tr><tr><td><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktPn">(</span><span class="RktMeta">lambda</span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktMeta">k</span><span class="RktPn">)</span><span class="RktMeta"></span></td></tr><tr><td><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktPn">(</span><span class="RktMeta">lambda</span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktMeta">k</span><span class="RktPn">)</span><span class="RktMeta"></span></td></tr><tr><td><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktMeta">k</span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktVal">"Second"</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktMeta">lambda</span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktMeta">pv</span><span class="RktPn">)</span><span class="RktMeta"></span></td></tr><tr><td><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktMeta">read-number/suspend</span><span class="hspace">&nbsp;</span><span class="RktMeta">pv</span><span class="hspace">&nbsp;</span><span class="RktMeta">k</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktMeta"></span></td></tr><tr><td><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktMeta">lambda</span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktMeta">rv</span><span class="RktPn">)</span><span class="RktMeta"></span></td></tr><tr><td><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktMeta">k</span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktMeta">+</span><span class="hspace">&nbsp;</span><span class="RktMeta">lv</span><span class="hspace">&nbsp;</span><span class="RktMeta">rv</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktMeta"></span></td></tr><tr><td><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktMeta">lambda</span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktMeta">ov</span><span class="RktPn">)</span><span class="RktMeta"></span></td></tr><tr><td><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktMeta">k</span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktMeta">display</span><span class="hspace">&nbsp;</span><span class="RktMeta">ov</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktMeta"></span></td></tr></table></blockquote></div><div class="SIntrapara">What!  This isn&rsquo;t at all the version we wrote by hand!</div></p><p>In fact, this program is full of so-called <span style="font-style: italic">administrative</span>
<span class="stt">lambda</span>s that were introduced by the particular <span class="Smaller">CPS</span> algorithm
we used.<span class="refelem"><span class="refcolumn"><span class="refcontent">Designing better <span class="Smaller">CPS</span> algorithms, that eliminate
needless administrative <span class="stt">lambda</span>s, is therefore an ongoing and
open research question.</span></span></span>  Fear not!  If we stepwise apply each of
these <span class="stt">lambda</span>s and substitute, however&#8212;<wbr></wbr></p><p><div class="SIntrapara"><span style="font-weight: bold">Do Now!</span></div><div class="SIntrapara"><blockquote><p>Do it!</p></blockquote></div></p><p><div class="SIntrapara">&#8212;<wbr></wbr>the program reduces to
</div><div class="SIntrapara"><blockquote class="SCodeFlow"><table cellspacing="0" cellpadding="0" class="RktBlk"><tr><td><span class="RktPn">(</span><span class="RktMeta">read-number/suspend</span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktVal">"First"</span><span class="RktMeta"></span></td></tr><tr><td><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktMeta">lambda</span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktMeta">lv</span><span class="RktPn">)</span><span class="RktMeta"></span></td></tr><tr><td><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktMeta">read-number/suspend</span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktVal">"Second"</span><span class="RktMeta"></span></td></tr><tr><td><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktMeta">lambda</span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktMeta">rv</span><span class="RktPn">)</span><span class="RktMeta"></span></td></tr><tr><td><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktMeta">identity</span></td></tr><tr><td><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktMeta">display</span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktMeta">+</span><span class="hspace">&nbsp;</span><span class="RktMeta">lv</span><span class="hspace">&nbsp;</span><span class="RktMeta">rv</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktMeta"></span></td></tr></table></blockquote></div><div class="SIntrapara">which is precisely what we wanted.</div></p><h5>14.2.3<tt>&nbsp;</tt><a name="(part._.Implementation_in_the_.Core)"></a>Implementation in the Core</h5><p>Now that we&rsquo;ve seen how <span class="Smaller">CPS</span> can be implemented through desugaring, we
should ask whether it can be put in the core instead.</p><p>Recall that we&rsquo;ve said that <span class="Smaller">CPS</span> applies to all programs.  We have one
program we are especially interested in: the interpreter.  Sure
enough, we can apply the <span class="Smaller">CPS</span> transformation to it, making available
what are effectively the same continuations.</p><p>First, we&rsquo;ll find it convenient to use a procedural representation of
closures [REF].  We&rsquo;ll have the interpreter take an extra argument,
which consumes values (those given to the continuation) and eventually
returns them:</p><p><div class="SIntrapara"><a name="(elem._(chunk._~3ccps-interp~3e~3a1))"></a><span style="font-weight: bold"><span style="font-style: italic"><a href="#%28elem._%28chunk._~3ccps-interp~3e~3a1%29%29" class="plainlink" data-pltdoc="x">&lt;cps-interp&gt;</a></span> ::=</span></div><div class="SIntrapara"><blockquote class="SCodeFlow"><table cellspacing="0" cellpadding="0" class="RktBlk"><tr><td><span class="RktPn">(</span><span class="RktSym">define</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">interp/k</span><span class="hspace">&nbsp;</span><span class="RktPn">[</span><span class="RktSym">expr</span><span class="hspace">&nbsp;</span><span class="RktSym">:</span><span class="hspace">&nbsp;</span><span class="RktSym">ExprC</span><span class="RktPn">]</span><span class="hspace">&nbsp;</span><span class="RktPn">[</span><span class="RktSym">env</span><span class="hspace">&nbsp;</span><span class="RktSym">:</span><span class="hspace">&nbsp;</span><span class="RktSym">Env</span><span class="RktPn">]</span><span class="hspace">&nbsp;</span><span class="RktPn">[</span><span class="RktSym">k</span><span class="hspace">&nbsp;</span><span class="RktSym">:</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">Value</span><span class="hspace">&nbsp;</span><span class="RktSym"><span class="nobreak">-&gt;</span></span><span class="hspace">&nbsp;</span><span class="RktSym">Value</span><span class="RktPn">)</span><span class="RktPn">]</span><span class="RktPn">)</span><span class="hspace">&nbsp;</span><span class="RktSym">:</span><span class="hspace">&nbsp;</span><span class="RktSym">Value</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;</span><a href="#%28elem._%28chunk._~3ccps-interp-body~3e~3a1%29%29" class="plainlink" data-pltdoc="x">&lt;cps-interp-body&gt;</a><span class="RktPn">)</span></td></tr></table></blockquote></div></p><p>In the easy cases, instead of returning a value we need to simply pass
it to the continuation argument:</p><p><div class="SIntrapara"><a name="(elem._(chunk._~3ccps-interp-body~3e~3a1))"></a><span style="font-weight: bold"><span style="font-style: italic"><a href="#%28elem._%28chunk._~3ccps-interp-body~3e~3a1%29%29" class="plainlink" data-pltdoc="x">&lt;cps-interp-body&gt;</a></span> ::=</span></div><div class="SIntrapara"><blockquote class="SCodeFlow"><table cellspacing="0" cellpadding="0" class="RktBlk"><tr><td><span class="RktPn">(</span><span class="RktSym">type-case</span><span class="hspace">&nbsp;</span><span class="RktSym">ExprC</span><span class="hspace">&nbsp;</span><span class="RktSym">expr</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;</span><span class="RktPn">[</span><span class="RktSym">numC</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">n</span><span class="RktPn">)</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">k</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">numV</span><span class="hspace">&nbsp;</span><span class="RktSym">n</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">]</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;</span><span class="RktPn">[</span><span class="RktSym">idC</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">n</span><span class="RktPn">)</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">k</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">lookup</span><span class="hspace">&nbsp;</span><span class="RktSym">n</span><span class="hspace">&nbsp;</span><span class="RktSym">env</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">]</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;</span><a href="#%28elem._%28chunk._~3ccps-interp-plus.C-case~3e~3a1%29%29" class="plainlink" data-pltdoc="x">&lt;cps-interp-plusC-case&gt;</a></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;</span><a href="#%28elem._%28chunk._~3ccps-interp-app.C-case~3e~3a1%29%29" class="plainlink" data-pltdoc="x">&lt;cps-interp-appC-case&gt;</a></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;</span><a href="#%28elem._%28chunk._~3ccps-interp-lam.C-case~3e~3a1%29%29" class="plainlink" data-pltdoc="x">&lt;cps-interp-lamC-case&gt;</a><span class="RktPn">)</span></td></tr></table></blockquote></div></p><p>(Note that <span class="stt">multC</span> is handled entirely analogous to
<span class="stt">plusC</span>.)</p><p>Let&rsquo;s start with the easy case, <span class="stt">plusC</span>.  First we interpret the
left sub-expression.  The continuation for this evaluation interprets
the right sub-expression.  The continuation for that adds the result.
What should happen to the result of addition?  In <span class="stt">interp</span>, it
was returned to whichever computation caused the <span class="stt">plusC</span> to be
interpreted.  Now, remember, we no longer return values; instead we
pass them to the continuation:</p><p><div class="SIntrapara"><a name="(elem._(chunk._~3ccps-interp-plus.C-case~3e~3a1))"></a><span style="font-weight: bold"><span style="font-style: italic"><a href="#%28elem._%28chunk._~3ccps-interp-plus.C-case~3e~3a1%29%29" class="plainlink" data-pltdoc="x">&lt;cps-interp-plusC-case&gt;</a></span> ::=</span></div><div class="SIntrapara"><blockquote class="SCodeFlow"><table cellspacing="0" cellpadding="0" class="RktBlk"><tr><td><span class="RktPn">[</span><span class="RktSym">plusC</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">l</span><span class="hspace">&nbsp;</span><span class="RktSym">r</span><span class="RktPn">)</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">interp/k</span><span class="hspace">&nbsp;</span><span class="RktSym">l</span><span class="hspace">&nbsp;</span><span class="RktSym">env</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym">lambda</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">lv</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym">interp/k</span><span class="hspace">&nbsp;</span><span class="RktSym">r</span><span class="hspace">&nbsp;</span><span class="RktSym">env</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym">lambda</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">rv</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym">k</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">num+</span><span class="hspace">&nbsp;</span><span class="RktSym">lv</span><span class="hspace">&nbsp;</span><span class="RktSym">rv</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">]</span></td></tr></table></blockquote></div></p><p><div class="SIntrapara"><span style="font-weight: bold">Exercise</span></div><div class="SIntrapara"><blockquote><p>Implement the code for <span class="stt">multC</span>.</p></blockquote></div></p><p>This leaves the two difficult, and related, pieces.</p><p><div class="SIntrapara">In an application, we again have to interpret the two sub-expressions,
and then apply the resulting closure to the argument.  But we&rsquo;ve
already agreed that every application needs a continuation argument.
Therefore, we have to update our definition of a value:
</div><div class="SIntrapara"><blockquote class="SCodeFlow"><table cellspacing="0" cellpadding="0" class="RktBlk"><tr><td><span class="RktPn">(</span><span class="RktMeta">define-type</span><span class="hspace">&nbsp;</span><span class="RktMeta">Value</span></td></tr><tr><td><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktPn">[</span><span class="RktMeta">numV</span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktMeta">n</span><span class="hspace">&nbsp;</span><span class="RktMeta">:</span><span class="hspace">&nbsp;</span><span class="RktMeta">number</span><span class="RktPn">)</span><span class="RktPn">]</span><span class="RktMeta"></span></td></tr><tr><td><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktPn">[</span><span class="RktMeta">closV</span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktMeta">f</span><span class="hspace">&nbsp;</span><span class="RktMeta">:</span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktMeta">Value</span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktMeta">Value</span><span class="hspace">&nbsp;</span><span class="RktMeta">-&gt;</span><span class="hspace">&nbsp;</span><span class="RktMeta">Value</span><span class="RktPn">)</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta">-&gt;</span><span class="hspace">&nbsp;</span><span class="RktMeta">Value</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">]</span><span class="RktPn">)</span><span class="RktMeta"></span></td></tr></table></blockquote></div></p><p>Now we have to decide what continuation to pass.  In an application,
it&rsquo;s the continuation given to the interpreter:</p><p><div class="SIntrapara"><a name="(elem._(chunk._~3ccps-interp-app.C-case~3e~3a1))"></a><span style="font-weight: bold"><span style="font-style: italic"><a href="#%28elem._%28chunk._~3ccps-interp-app.C-case~3e~3a1%29%29" class="plainlink" data-pltdoc="x">&lt;cps-interp-appC-case&gt;</a></span> ::=</span></div><div class="SIntrapara"><blockquote class="SCodeFlow"><table cellspacing="0" cellpadding="0" class="RktBlk"><tr><td><span class="RktPn">[</span><span class="RktSym">appC</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">f</span><span class="hspace">&nbsp;</span><span class="RktSym">a</span><span class="RktPn">)</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">interp/k</span><span class="hspace">&nbsp;</span><span class="RktSym">f</span><span class="hspace">&nbsp;</span><span class="RktSym">env</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym">lambda</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">fv</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym">interp/k</span><span class="hspace">&nbsp;</span><span class="RktSym">a</span><span class="hspace">&nbsp;</span><span class="RktSym">env</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym">lambda</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">av</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktPn">(</span><span class="RktSym">closV-f</span><span class="hspace">&nbsp;</span><span class="RktSym">fv</span><span class="RktPn">)</span><span class="hspace">&nbsp;</span><span class="RktSym">av</span><span class="hspace">&nbsp;</span><span class="RktSym">k</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">]</span></td></tr></table></blockquote></div></p><p>Finally, the <span class="stt">lamC</span> case.  We have to create a <span class="stt">closV</span> using
a <span class="stt">lambda</span>, as before.  However, this procedure needs to take two
arguments: the actual value of the argument, and the continuation of
the application.  The critical question is, what is this latter value?</p><p>We have essentially two choices. <span class="stt">k</span> represents the <span style="font-style: italic">static</span>
continuation: the one active at the point of closure
<span style="font-style: italic">construction</span>.  However, what we want is the continuation at the
point of closure <span style="font-style: italic">invocation</span>: the <span style="font-style: italic">dynamic</span> continuation.</p><p><div class="SIntrapara"><a name="(elem._(chunk._~3ccps-interp-lam.C-case~3e~3a1))"></a><span style="font-weight: bold"><span style="font-style: italic"><a href="#%28elem._%28chunk._~3ccps-interp-lam.C-case~3e~3a1%29%29" class="plainlink" data-pltdoc="x">&lt;cps-interp-lamC-case&gt;</a></span> ::=</span></div><div class="SIntrapara"><blockquote class="SCodeFlow"><table cellspacing="0" cellpadding="0" class="RktBlk"><tr><td><span class="RktPn">[</span><span class="RktSym">lamC</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">a</span><span class="hspace">&nbsp;</span><span class="RktSym">b</span><span class="RktPn">)</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">k</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">closV</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">lambda</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">arg-val</span><span class="hspace">&nbsp;</span><span class="RktSym">dyn-k</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym">interp/k</span><span class="hspace">&nbsp;</span><span class="RktSym">b</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym">extend-env</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">bind</span><span class="hspace">&nbsp;</span><span class="RktSym">a</span><span class="hspace">&nbsp;</span><span class="RktSym">arg-val</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktSym">env</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktSym">dyn-k</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">]</span></td></tr></table></blockquote></div></p><p><div class="SIntrapara">To test this revised interpreter, we need to invoke <span class="stt">interp/k</span>
with some kind of initial continuation value.  This needs to be a
procedure that represents nothing remaining in the computation.  A
natural representation for this is the identity function:
</div><div class="SIntrapara"><blockquote class="SCodeFlow"><table cellspacing="0" cellpadding="0" class="RktBlk"><tr><td><span class="RktPn">(</span><span class="RktMeta">define</span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktMeta">interp</span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktPn">[</span><span class="RktMeta">expr</span><span class="hspace">&nbsp;</span><span class="RktMeta">:</span><span class="hspace">&nbsp;</span><span class="RktMeta">ExprC</span><span class="RktPn">]</span><span class="RktPn">)</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta">:</span><span class="hspace">&nbsp;</span><span class="RktMeta">Value</span></td></tr><tr><td><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktMeta">interp/k</span><span class="hspace">&nbsp;</span><span class="RktMeta">expr</span><span class="hspace">&nbsp;</span><span class="RktMeta">mt-env</span></td></tr><tr><td><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktMeta">lambda</span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktMeta">ans</span><span class="RktPn">)</span><span class="RktMeta"></span></td></tr><tr><td><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktMeta">ans</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktMeta"></span></td></tr></table></blockquote></div><div class="SIntrapara">To signify that this is strictly a top-level interface to
<span class="stt">interp/k</span>, we&rsquo;ve dropped the environment parameter and pass the
empty environment automatically.  If we want to be especially sure we
haven&rsquo;t accidentally used this procedure recursively, we could insert
a call to <span class="stt">error</span> at its end to prevent it from returning and its
return value being used.</div></p><h4>14.3<tt>&nbsp;</tt><a name="(part._.Generators)"></a>Generators</h4><p>Many programming languages now have a notion of <span style="font-style: italic">generators</span>.  A
generator is like a procedure, in that one can invoke it in an
application.  Whereas a regular procedure always begins execution at
the beginning, a generator <span style="font-style: italic">resumes</span> from where it last
left off.  Of course, that means a generator needs a notion of
&ldquo;exiting before it&rsquo;s done&rdquo;.  This is known as <span style="font-style: italic">yielding</span>, namely
returning control to whatever called it.</p><h5>14.3.1<tt>&nbsp;</tt><a name="(part._.Design_.Variations)"></a>Design Variations</h5><p><div class="SIntrapara">There are many variations between generators.  The points of
variation, predictably, have to do with how to enter and exit a
generator:
</div><div class="SIntrapara"><ul><li><p>In some languages a generator is an object that is
instantiated like any other object, and its execution is resumed by
invoking a method (such as <span class="stt">next</span> in Python).  In others it is
just like a procedure, and indeed it is re-entered by applying it
like a function.<span class="refelem"><span class="refcolumn"><span class="refcontent">In languages where values in addition
to regular procedures can be used in an application, all such values
are collectively called <span style="font-style: italic">applicables</span>.</span></span></span></p></li><li><p>In some languages the yielding operation&#8212;<wbr></wbr>such as Python&rsquo;s
<span class="stt">yield</span>&#8212;<wbr></wbr>is available only inside the syntactic body of the
generator.  In others, such as Racket, <span class="stt">yield</span> is an applicable
value bound in the body, but by virtue of being a value, it can be
passed to abstractions, stored in data structures, and so on.</p></li></ul></div><div class="SIntrapara">Python&rsquo;s design represents an extreme point in that a generator is
simply <span style="font-style: italic">any function that contains the keyword <span class="stt">yield</span> in
its body</span>.  In addition, Python&rsquo;s <span class="stt">yield</span> cannot be passed as a
parameter to another function that performs the yielding on behalf of
the generator.</div></p><p><div class="SIntrapara">There is also a small issue of naming.  In many languages with
generators, the yielder is <span style="font-style: italic">automatically</span> called word
<span class="stt">yield</span>: either as a keyword (as in Python) or as an identifier
bound to an applicable value (as in Racket).  Another
possibility is that the user of the generator must indicate in the
generator expression what name to give the
yielder.<span class="refelem"><span class="refcolumn"><span class="refcontent">Curiously, Python expects users to determine
what to call <span class="stt">self</span> or <span class="stt">this</span> in objects, but it does not
provide the same flexibility for <span class="stt">yield</span>, because it has no other
way to determine which functions are generators!</span></span></span>  That is, a use
might look like
</div><div class="SIntrapara"><blockquote class="SCodeFlow"><table cellspacing="0" cellpadding="0" class="RktBlk"><tr><td><span class="RktPn">(</span><span class="RktMeta">generator</span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktMeta">yield</span><span class="RktPn">)</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktMeta">from</span><span class="RktPn">)</span><span class="RktMeta"></span></td></tr><tr><td><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktMeta">rec</span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktMeta">f</span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktMeta">lam</span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktMeta">n</span><span class="RktPn">)</span><span class="RktMeta"></span></td></tr><tr><td><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktMeta">seq</span></td></tr><tr><td><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktMeta">yield</span><span class="hspace">&nbsp;</span><span class="RktMeta">n</span><span class="RktPn">)</span><span class="RktMeta"></span></td></tr><tr><td><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktMeta">f</span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktMeta">+</span><span class="hspace">&nbsp;</span><span class="RktMeta">n</span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktVal">1</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktMeta"></span></td></tr><tr><td><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktMeta">f</span><span class="hspace">&nbsp;</span><span class="RktMeta">from</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktMeta"></span></td></tr></table></blockquote></div><div class="SIntrapara">but it might equivalently be
</div><div class="SIntrapara"><blockquote class="SCodeFlow"><table cellspacing="0" cellpadding="0" class="RktBlk"><tr><td><span class="RktPn">(</span><span class="RktMeta">generator</span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktMeta">y</span><span class="RktPn">)</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktMeta">from</span><span class="RktPn">)</span><span class="RktMeta"></span></td></tr><tr><td><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktMeta">rec</span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktMeta">f</span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktMeta">lam</span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktMeta">n</span><span class="RktPn">)</span><span class="RktMeta"></span></td></tr><tr><td><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktMeta">seq</span></td></tr><tr><td><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktMeta">y</span><span class="hspace">&nbsp;</span><span class="RktMeta">n</span><span class="RktPn">)</span><span class="RktMeta"></span></td></tr><tr><td><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktMeta">f</span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktMeta">+</span><span class="hspace">&nbsp;</span><span class="RktMeta">n</span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktVal">1</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktMeta"></span></td></tr><tr><td><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktMeta">f</span><span class="hspace">&nbsp;</span><span class="RktMeta">from</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktMeta"></span></td></tr></table></blockquote></div><div class="SIntrapara">and if the yielder is an actual value, a user
can also abstract over yielding:
</div><div class="SIntrapara"><blockquote class="SCodeFlow"><table cellspacing="0" cellpadding="0" class="RktBlk"><tr><td><span class="RktPn">(</span><span class="RktMeta">generator</span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktMeta">y</span><span class="RktPn">)</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktMeta">from</span><span class="RktPn">)</span><span class="RktMeta"></span></td></tr><tr><td><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktMeta">rec</span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktMeta">f</span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktMeta">lam</span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktMeta">n</span><span class="RktPn">)</span><span class="RktMeta"></span></td></tr><tr><td><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktMeta">seq</span></td></tr><tr><td><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktPn">(</span><span class="RktMeta">yield-helper</span><span class="hspace">&nbsp;</span><span class="RktMeta">y</span><span class="RktPn">)</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta">n</span><span class="RktPn">)</span><span class="RktMeta"></span></td></tr><tr><td><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktMeta">f</span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktMeta">+</span><span class="hspace">&nbsp;</span><span class="RktMeta">n</span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktVal">1</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktMeta"></span></td></tr><tr><td><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktMeta">f</span><span class="hspace">&nbsp;</span><span class="RktMeta">from</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktMeta"></span></td></tr></table></blockquote></div><div class="SIntrapara">where <span class="stt">yield-helper</span> will presumably perform the actual yielding.</div></p><p><div class="SIntrapara">There are actually two more design decisions:
</div><div class="SIntrapara"><ol><li><p>Is <span class="stt">yield</span> a statement or expression?  In many languages
it is actually an expression, meaning it has a value: the one
supplied when resuming the generator.  This makes the generator more
flexible because the user of a generator can use the parameter(s) to
alter the generator&rsquo;s behavior, rather than being <span style="font-style: italic">forced</span> to
use state to communicate desired changes.</p></li><li><p>What happens at the end of the generator&rsquo;s execution?  In many
languages, a generator raises an exception to signal its completion.</p></li></ol></div></p><h5>14.3.2<tt>&nbsp;</tt><a name="(part._.Implementing_.Generators)"></a>Implementing Generators</h5><p>To implement generators, it will be especially useful to employ our
<span class="Smaller">CPS</span> macro language.  Let&rsquo;s first decide where we stand regarding the
above design decisions.  We will use the applicative representation of
generators: that is, asking for the next value from the generator is
done by applying it to any necessary arguments.  Similarly, the
yielder will also be an applicable value and will in turn be an
expression.  Though we have already seen how macros can automatically
capture a name [REF], let&rsquo;s make the yielder&rsquo;s name explicit to keep
the macro simpler.  Finally, we&rsquo;ll raise an error when the generator
is done executing.</p><p><div class="SIntrapara">How do generators work?  To yield, a generator must
</div><div class="SIntrapara"><ul><li><p>remember where in its execution it currently is, and</p></li><li><p>know where in its caller it should return to.</p></li></ul></div><div class="SIntrapara">while, when invoked, it should
</div><div class="SIntrapara"><ul><li><p>remember where in its execution its caller currently is, and</p></li><li><p>know where in its body it should return to.</p></li></ul></div><div class="SIntrapara">Observe the duality between invocation and yielding.</div></p><p>As you might guess, these &ldquo;where&rdquo;s correspond to continuations.</p><p>Let&rsquo;s build up the generator rule of the <span class="stt">cps</span> macro
incrementally.  First a header pattern:</p><p><div class="SIntrapara"><a name="(elem._(chunk._~3ccps-macro-generator-case~3e~3a1))"></a><span style="font-weight: bold"><span style="font-style: italic"><a href="#%28elem._%28chunk._~3ccps-macro-generator-case~3e~3a1%29%29" class="plainlink" data-pltdoc="x">&lt;cps-macro-generator-case&gt;</a></span> ::=</span></div><div class="SIntrapara"><blockquote class="SCodeFlow"><table cellspacing="0" cellpadding="0" class="RktBlk"><tr><td><span class="RktPn">[</span><span class="RktPn">(</span><span class="RktSym">_</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">generator</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">yield</span><span class="RktPn">)</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">v</span><span class="RktPn">)</span><span class="hspace">&nbsp;</span><span class="RktSym">b</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">and</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">identifier?</span><span class="hspace">&nbsp;</span><span class="RktRdr">#'</span><span class="RktSym">v</span><span class="RktPn">)</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">identifier?</span><span class="hspace">&nbsp;</span><span class="RktRdr">#'</span><span class="RktSym">yield</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;</span><a href="#%28elem._%28chunk._~3cgenerator-body~3e~3a1%29%29" class="plainlink" data-pltdoc="x">&lt;generator-body&gt;</a><span class="RktPn">]</span></td></tr></table></blockquote></div></p><p>The beginning of the body is easy: all code in <span class="Smaller">CPS</span> needs to consume a
continuation, and because a generator is a value, this value should be
supplied to the continuation:</p><p><div class="SIntrapara"><a name="(elem._(chunk._~3cgenerator-body~3e~3a1))"></a><span style="font-weight: bold"><span style="font-style: italic"><a href="#%28elem._%28chunk._~3cgenerator-body~3e~3a1%29%29" class="plainlink" data-pltdoc="x">&lt;generator-body&gt;</a></span> ::=</span></div><div class="SIntrapara"><blockquote class="SCodeFlow"><table cellspacing="0" cellpadding="0" class="RktBlk"><tr><td><span class="RktRdr">#'</span><span class="RktPn">(</span><span class="RktSym">lambda</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">k</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym">k</span><span class="hspace">&nbsp;</span><a href="#%28elem._%28chunk._~3cgenerator-value~3e~3a1%29%29" class="plainlink" data-pltdoc="x">&lt;generator-value&gt;</a><span class="RktPn">)</span><span class="RktPn">)</span></td></tr></table></blockquote></div></p><p>Now we&rsquo;re ready to tackle the heart of the generator.</p><p>Recall that a generator is an applicable value.  That means it can
occur in an application position, and must therefore have the same
&ldquo;interface&rdquo; as a procedure: a procedure of two arguments, the first
a value and the second the continuation at the point of application.
What should this procedure do?  We&rsquo;ve described just this above.
First the generator must remember where the caller is in its
execution, which is precisely the continuation at the point of
application; &ldquo;remember&rdquo; here most simply means &ldquo;must be stored in
state&rdquo;. Then, the generator should return to where it previously was,
i.e., its <span style="font-style: italic">own</span> continuation, which must clearly have been
stored.  Therefore the core of the applicable value is:</p><p><div class="SIntrapara"><a name="(elem._(chunk._~3cgenerator-core~3e~3a1))"></a><span style="font-weight: bold"><span style="font-style: italic"><a href="#%28elem._%28chunk._~3cgenerator-core~3e~3a1%29%29" class="plainlink" data-pltdoc="x">&lt;generator-core&gt;</a></span> ::=</span></div><div class="SIntrapara"><blockquote class="SCodeFlow"><table cellspacing="0" cellpadding="0" class="RktBlk"><tr><td><span class="RktPn">(</span><span class="RktSym">lambda</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">v</span><span class="hspace">&nbsp;</span><span class="RktSym">dyn-k</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym">begin</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym">set!</span><span class="hspace">&nbsp;</span><span class="RktSym">where-to-go</span><span class="hspace">&nbsp;</span><span class="RktSym">dyn-k</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym">resumer</span><span class="hspace">&nbsp;</span><span class="RktSym">v</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr></table></blockquote></div></p><p>Here, <span class="stt">where-to-go</span> records the continuation of the caller, to
resume it upon yielding; <span class="stt">resumer</span> is the local continuation of
the generator.  Let&rsquo;s think about what their initial values must be:</p><ul><li><p><span class="stt">where-to-go</span> has no initial value (because the generator
has yet to be invoked), so it needs to throw an error if ever used.
Fortunately this error will never occur, because <span class="stt">where-to-go</span>
is mutated on the first entry into the generator, so the error is
just a safeguard against bugs in the implementation.</p></li><li><p>Initially, the rest of the generator is the whole generator,
so <span class="stt">resumer</span> should be bound to the (<span class="Smaller">CPS</span> of) <span class="stt">b</span>.  What
is its continuation?  This is the continuation of the entire
generator, i.e., what to do when the generator finishes.  We&rsquo;ve
agreed that this should also signal an error (except in this case
the error truly can occur, in case the generator is asked to produce
more values than it&rsquo;s equipped to).</p></li></ul><p>We still need to bind <span class="stt">yield</span>.  It is, as we&rsquo;ve pointed out,
symmetric to generator resumption: save the local continuation in
<span class="stt">resumer</span> and return by applying <span class="stt">where-to-go</span>.</p><p>Putting together these pieces, we get:</p><p><div class="SIntrapara"><a name="(elem._(chunk._~3cgenerator-value~3e~3a1))"></a><span style="font-weight: bold"><span style="font-style: italic"><a href="#%28elem._%28chunk._~3cgenerator-value~3e~3a1%29%29" class="plainlink" data-pltdoc="x">&lt;generator-value&gt;</a></span> ::=</span></div><div class="SIntrapara"><blockquote class="SCodeFlow"><table cellspacing="0" cellpadding="0" class="RktBlk"><tr><td><span class="RktPn">(</span><span class="RktSym">let</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktPn">[</span><span class="RktSym">where-to-go</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">lambda</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">v</span><span class="RktPn">)</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">error</span><span class="hspace">&nbsp;</span><span class="RktVal">'</span><span class="RktVal">where-to-go</span><span class="hspace">&nbsp;</span><span class="RktVal">"nothing"</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">]</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym">letrec</span><span class="RktPn">(</span><span class="RktPn">[</span><span class="RktSym">resumer</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">lambda</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">v</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktPn">(</span><span class="RktSym">cps</span><span class="hspace">&nbsp;</span><span class="RktSym">b</span><span class="RktPn">)</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">lambda</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">k</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym">error</span><span class="hspace">&nbsp;</span><span class="RktVal">'</span><span class="RktVal">generator</span><span class="hspace">&nbsp;</span><span class="RktVal">"fell through"</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">]</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">[</span><span class="RktSym">yield</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">lambda</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">v</span><span class="hspace">&nbsp;</span><span class="RktSym">gen-k</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym">begin</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym">set!</span><span class="hspace">&nbsp;</span><span class="RktSym">resumer</span><span class="hspace">&nbsp;</span><span class="RktSym">gen-k</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym">where-to-go</span><span class="hspace">&nbsp;</span><span class="RktSym">v</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">]</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;</span><a href="#%28elem._%28chunk._~3cgenerator-core~3e~3a1%29%29" class="plainlink" data-pltdoc="x">&lt;generator-core&gt;</a><span class="RktPn">)</span><span class="RktPn">)</span></td></tr></table></blockquote></div></p><p><div class="SIntrapara"><span style="font-weight: bold">Do Now!</span></div><div class="SIntrapara"><blockquote><p>Why this pattern of <span class="stt">let</span> and <span class="stt">letrec</span> instead of <span class="stt">let</span>?</p></blockquote></div></p><p>Observe the dependencies between these code fragments.
<span class="stt">where-to-go</span> doesn&rsquo;t depend on either of <span class="stt">resumer</span> or
<span class="stt">yield</span>.  <span class="stt">yield</span> clearly depends on both <span class="stt">where-to-go</span>
and <span class="stt">resumer</span>.  But why are <span class="stt">resumer</span> and <span class="stt">yield</span>
mutually referential?</p><p><div class="SIntrapara"><span style="font-weight: bold">Do Now!</span></div><div class="SIntrapara"><blockquote><p>Try the alternative!</p></blockquote></div></p><p>The subtle dependency you may be missing is that <span class="stt">resumer</span>
contains <span class="stt">b</span>, the body of the generator, which may contain
references to <span class="stt">yield</span>.  Therefore, it needs to be closed over the
binding of the yielder.</p><p><div class="SIntrapara"><span style="font-weight: bold">Exercise</span></div><div class="SIntrapara"><blockquote><p>How do generators differ from coroutines and threads?  Implement
coroutines and threads using a similar strategy.</p></blockquote></div></p><h4>14.4<tt>&nbsp;</tt><a name="(part._.Continuations_and_.Stacks)"></a>Continuations and Stacks</h4><p><div class="SIntrapara">Surprising as it may seem, <span class="Smaller">CPS</span> conversion actually provides
tremendous insight into the nature of the program execution
<span style="font-style: italic">stack</span>.  The first thing to understand is that every continuation
is actually <span style="font-style: italic">the stack itself</span>.  This might seem odd, given that
stacks are low-level machine primitives while continuations are
seemingly complex procedures.  But what is the stack, really?
</div><div class="SIntrapara"><ul><li><p>It&rsquo;s a record of what remains to be done in the computation.
So is the continuation.</p></li><li><p>It&rsquo;s traditionally thought of as a list of stack <span style="font-style: italic">frames</span>.
That is, each frame has a reference to the frames remaining after it
finishes.  Similarly, each continuation is a small procedure that
refers to&#8212;<wbr></wbr>and hence closes over&#8212;<wbr></wbr>its own continuation.  If we had
chosen a different representation for program instructions,
combining this with the data structure representation of closures,
we would obtain a continuation representation that is essentially
the same as the machine stack.</p></li><li><p>Each stack frame also stores procedure parameters.  This is
implicitly managed by the procedural representation of
continuations, whereas this was done explicitly in the data stucture
representation (using <span class="stt">bind</span>).</p></li><li><p>Each frame also has space for &ldquo;local variables&rdquo;.  In
principle so does the continuation, though by using the macro
implementation of local binding, we&rsquo;ve effectively reduced
everything to procedure parameters.  Conceptually, however, some of
these are &ldquo;true&rdquo; procedure parameters while others are local
bindings turned into procedure parameters by a macro.</p></li><li><p>The stack has references to, but does not close over, the
heap.  Thus changes to the heap are visible across stack frames.  In
precisely the same way, closures refer to, but do not close over,
the store, so changes to the store are visible across closures.</p></li></ul></div><div class="SIntrapara">Therefore, traditionally the stack is responsible for maintaining
lexical scope, which we get automatically because we are using
closures in a statically-scoped language.</div></p><p><div class="SIntrapara">Now we can study the conversion of various terms to understand the
mapping to stacks.  For instance, consider the conversion of a
function application [REF]:
</div><div class="SIntrapara"><blockquote class="SCodeFlow"><table cellspacing="0" cellpadding="0" class="RktBlk"><tr><td><span class="RktPn">[</span><span class="RktPn">(</span><span class="RktMeta">_</span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktMeta">f</span><span class="hspace">&nbsp;</span><span class="RktMeta">a</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktMeta"></span></td></tr><tr><td><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktVal">#'</span><span class="RktPn">(</span><span class="RktMeta">lambda</span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktMeta">k</span><span class="RktPn">)</span><span class="RktMeta"></span></td></tr><tr><td><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktPn">(</span><span class="RktMeta">cps</span><span class="hspace">&nbsp;</span><span class="RktMeta">f</span><span class="RktPn">)</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktMeta">lambda</span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktMeta">fv</span><span class="RktPn">)</span><span class="RktMeta"></span></td></tr><tr><td><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktPn">(</span><span class="RktMeta">cps</span><span class="hspace">&nbsp;</span><span class="RktMeta">a</span><span class="RktPn">)</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktMeta">lambda</span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktMeta">av</span><span class="RktPn">)</span><span class="RktMeta"></span></td></tr><tr><td><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktMeta">fv</span><span class="hspace">&nbsp;</span><span class="RktMeta">av</span><span class="hspace">&nbsp;</span><span class="RktMeta">k</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">]</span><span class="RktMeta"></span></td></tr></table></blockquote></div><div class="SIntrapara">How do we &ldquo;read&rdquo; this?  As follows:
</div><div class="SIntrapara"><ul><li><p>Let&rsquo;s use <span class="stt">k</span> to refer to the stack present before the
function application begins to evaluate.</p></li><li><p>When we begin to evaluate the function position (<span class="stt">f</span>),
create a new stack frame (<span class="stt">(lambda (fv) ...)</span>).  This frame has
one free identifier: <span class="stt">k</span>.  Thus its closure needs to record one
element of the environment, namely the rest of the stack.</p></li><li><p>The code portion of the stack frame represents what is left to
be done once we obtain a value for the function: evaluate the
argument, and perform the application, and return the result to the
stack expecting the result of the application: <span class="stt">k</span>.</p></li><li><p>When evaluation of <span class="stt">f</span> completes, we begin to evaluate
<span class="stt">a</span>, which also creates a stack frame: <span class="stt">(lambda (av)
...)</span>.  This frame has <span style="font-style: italic">two</span> free identifiers: <span class="stt">k</span> and
<span class="stt">fv</span>.  This tells us:</p><ul><li><p>We no longer need the stack frame for evaluating the
function position, but</p></li><li><p>we now need a <span style="font-style: italic">temporary</span> that records the
value&#8212;<wbr></wbr>hopefully a function value&#8212;<wbr></wbr>of evaluating the function
position.</p></li></ul></li><li><p>The code portion of this second frame also represents what is
left to be done: invoke the function value with the argument, in the
stack expecting the value of the application.</p></li></ul></div></p><p><div class="SIntrapara">Let us apply similar reasoning to conditionals:
</div><div class="SIntrapara"><blockquote class="SCodeFlow"><table cellspacing="0" cellpadding="0" class="RktBlk"><tr><td><span class="RktPn">[</span><span class="RktPn">(</span><span class="RktMeta">_</span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktMeta">cnd</span><span class="hspace">&nbsp;</span><span class="RktMeta">tst</span><span class="hspace">&nbsp;</span><span class="RktMeta">thn</span><span class="hspace">&nbsp;</span><span class="RktMeta">els</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktMeta"></span></td></tr><tr><td><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktVal">#'</span><span class="RktPn">(</span><span class="RktMeta">lambda</span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktMeta">k</span><span class="RktPn">)</span><span class="RktMeta"></span></td></tr><tr><td><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktPn">(</span><span class="RktMeta">cps</span><span class="hspace">&nbsp;</span><span class="RktMeta">tst</span><span class="RktPn">)</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktMeta">lambda</span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktMeta">tstv</span><span class="RktPn">)</span><span class="RktMeta"></span></td></tr><tr><td><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktMeta">if</span><span class="hspace">&nbsp;</span><span class="RktMeta">tstv</span></td></tr><tr><td><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktPn">(</span><span class="RktMeta">cps</span><span class="hspace">&nbsp;</span><span class="RktMeta">thn</span><span class="RktPn">)</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta">k</span><span class="RktPn">)</span><span class="RktMeta"></span></td></tr><tr><td><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktPn">(</span><span class="RktMeta">cps</span><span class="hspace">&nbsp;</span><span class="RktMeta">els</span><span class="RktPn">)</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta">k</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">]</span><span class="RktMeta"></span></td></tr></table></blockquote></div><div class="SIntrapara">It says that to evaluate the conditional expression we have to create
a new stack frame.  This frame closes over the stack expecting the
value of the entire conditional.  This frame makes a decision based on
the value of the conditional expression, and invokes one of the other
expressions.  Once we have examined this value the frame created to
evaluate the conditional expression is no longer necessary, so
evaluation can proceed in <span class="stt">k</span>.</div></p><p>Viewed through this lens, we can more easily provide an operational
explanation for generators.  Each generator has its own private stack,
and when execution attempts to return past its end, our implementation
raises an error.  On invocation, a generator stores a reference to the
stack of the &ldquo;rest of the program&rdquo; in <span class="stt">where-to-go</span>, and
resumes its own stack, which is referred to by <span class="stt">resumer</span>.  On
yielding, the system swaps references to stacks.  Coroutines, threads,
and generators are all conceptually similar: they are all mechanisms
to create &ldquo;many little stacks&rdquo; instead of having a single, global
stack.</p><h4>14.5<tt>&nbsp;</tt><a name="(part._.Tail_.Calls)"></a>Tail Calls</h4><p>Observe that the stack patterns above add a frame to the current stack,
perform some evaluation, and eventually always return to the current
stack.  In particular, observe that in an application, we need stack
space to evaluate the function position and then the arguments, but
once all these are evaluated, we resume computation using the stack we
started out with before the application.  In other words,
<span style="font-style: italic">function calls do not themselves need to consume stack space</span>:
we only need space to compute the arguments.</p><p>However, not all languages observe or respect this property.  In
languages that do, programmers can use <span style="font-style: italic">recursion</span> to obtain
<span style="font-style: italic">iterative behavior</span>: i.e., a sequence of function calls can
consume no more stack space than no function calls at all.  This
removes the need to create special looping constructs; indeed, loops
can simply be expressed as a syntactic sugar.</p><p>Of course, this property does not apply in general.  If a call to
<span class="stt">f</span> is performed to compute an argument to a call to <span class="stt">g</span>,
the call to <span class="stt">f</span> is still consuming space relative to the context
surrounding <span class="stt">g</span>.  Thus, we should really speak of a relationship
between expressions: one expression is in <span style="font-style: italic">tail position</span> relative
to another if its evaluation requires no additional stack space beyond
the other.  In our <span class="Smaller">CPS</span> macro, every expression that uses <span class="stt">k</span> as
its continuation&#8212;<wbr></wbr>such as a function application after all the
sub-expressions have been evaluated, or the then- and else-branches of
a conditional&#8212;<wbr></wbr>are all in tail position relative to the enclosing
application (and perhaps recursively further up).  In contrast, every
expression that has to create a new stack frame is not in tail
position.</p><p>Some languages have special support for tail <span style="font-style: italic">recursion</span>: when a
procedure calls itself in tail position relative to its body.  This is
obviously useful, because it enables recursion to efficiently
implement loops.  However, it hurts &ldquo;loops&rdquo; that cannot be squeezed
into a single recursive function.  For instance, when implementing a
scanner or other state machine, it is most convenient to have a set of
functions each representing one state, and transitioning to other
states by making (tail) function calls.  It is onerous (and misses the
point) to turn these into a single recursive function.  If, however, a
language recognizes tail calls as such, it can optimize these
cross-function calls just as much as it does intra-function ones.</p><p>Racket, in particular, promises to implement tail calls without
allocating additional stack space.  Though some people refer to this
as &ldquo;tail call optimization&rdquo;, this term is misleading: an
optimization is optional, whereas whether or not a language promises
to properly implement tail calls is a <span style="font-style: italic">semantic</span> feature.
Developers need to know how the language will behave because it
affects how they program.</p><p>Because of this feature, observe something interesting about the
program after <span class="Smaller">CPS</span> transformation: all of its function applications
are themselves tail calls!  You can see this starting with the
<span class="stt">read-number/suspend</span> example that began this chapter: any
pending computation was put into the continuation argument.  Assuming
the program might terminate at any call is tantamount to not using any
stack space at all (because the stack would get wiped out).</p><p><div class="SIntrapara"><span style="font-weight: bold">Exercise</span></div><div class="SIntrapara"><blockquote><p>How is the program able to function in the absence of a stack?</p></blockquote></div></p><h4>14.6<tt>&nbsp;</tt><a name="(part._.Continuations_as_a_.Language_.Feature)"></a>Continuations as a Language Feature</h4><p>With this insight into the connection between continuations and
stacks, we can now return to the treatment of procedures: we ignored
the continuation at the point of closure <span style="font-style: italic">creation</span> and instead
only used the one at the point of closure <span style="font-style: italic">invocation</span>.  This of
course corresponds to normal procedure behavior.  But now we can ask,
what if we use the creation-time continuation instead?  This would
correspond to maintaining a reference to (a copy of) the stack at the
point of &ldquo;procedure&rdquo; creation, and when the procedure is applied,
ignoring the dynamic evaluation and going back to the point of
procedure creation.</p><p>In principle, we are trying to leave <span class="stt">lambda</span> intact and instead
give ourselves a language construct that corresponds to this
behavior:<span class="refelem"><span class="refcolumn"><span class="refcontent"><span style="font-style: italic">cc</span> = &ldquo;current continuation&rdquo;</span></span></span></p><p><div class="SIntrapara"><a name="(elem._(chunk._~3ccps-macro-let/cc-case~3e~3a1))"></a><span style="font-weight: bold"><span style="font-style: italic"><a href="#%28elem._%28chunk._~3ccps-macro-let%2Fcc-case~3e~3a1%29%29" class="plainlink" data-pltdoc="x">&lt;cps-macro-let/cc-case&gt;</a></span> ::=</span></div><div class="SIntrapara"><blockquote class="SCodeFlow"><table cellspacing="0" cellpadding="0" class="RktBlk"><tr><td><span class="RktPn">[</span><span class="RktPn">(</span><span class="RktSym">_</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">let/cc</span><span class="hspace">&nbsp;</span><span class="RktSym">kont</span><span class="hspace">&nbsp;</span><span class="RktSym">b</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">identifier?</span><span class="hspace">&nbsp;</span><span class="RktRdr">#'</span><span class="RktSym">kont</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;</span><span class="RktRdr">#'</span><span class="RktPn">(</span><span class="RktSym">lambda</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">k</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym">let</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktPn">[</span><span class="RktSym">kont</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">lambda</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">v</span><span class="hspace">&nbsp;</span><span class="RktSym">dyn-k</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym">k</span><span class="hspace">&nbsp;</span><span class="RktSym">v</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">]</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktPn">(</span><span class="RktSym">cps</span><span class="hspace">&nbsp;</span><span class="RktSym">b</span><span class="RktPn">)</span><span class="hspace">&nbsp;</span><span class="RktSym">k</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">]</span></td></tr></table></blockquote></div></p><p>What this says is that either way, control will return to the
expression that immediately surrounds the <span class="stt">let/cc</span>: either by
falling through (because the continuation of the body, <span class="stt">b</span>, is
<span class="stt">k</span>) or&#8212;<wbr></wbr>more interestingly&#8212;<wbr></wbr>by invoking the continuation,
which discards the dynamic continuation <span class="stt">dyn/k</span> by simply
ignoring it and returning to <span class="stt">k</span> instead.</p><p><div class="SIntrapara">Here&rsquo;s the simplest test:
</div><div class="SIntrapara"><blockquote class="SCodeFlow"><table cellspacing="0" cellpadding="0" class="RktBlk"><tr><td><span class="RktPn">(</span><span class="RktMeta">test</span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktMeta">run</span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktMeta">cps</span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktMeta">let/cc</span><span class="hspace">&nbsp;</span><span class="RktMeta">esc</span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktVal">3</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktMeta"></span></td></tr><tr><td><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktVal">3</span><span class="RktPn">)</span><span class="RktMeta"></span></td></tr></table></blockquote></div><div class="SIntrapara">This confirms that if we never use the continuation, evaluation of the
body proceeds as if the <span class="stt">let/cc</span> weren&rsquo;t there at all (because of
the <span class="stt">((cps b) k)</span>).  If we use it, the value given to the
continuation returns to the point of creation:
</div><div class="SIntrapara"><blockquote class="SCodeFlow"><table cellspacing="0" cellpadding="0" class="RktBlk"><tr><td><span class="RktPn">(</span><span class="RktMeta">test</span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktMeta">run</span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktMeta">cps</span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktMeta">let/cc</span><span class="hspace">&nbsp;</span><span class="RktMeta">esc</span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktMeta">esc</span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktVal">3</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktMeta"></span></td></tr><tr><td><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktVal">3</span><span class="RktPn">)</span><span class="RktMeta"></span></td></tr></table></blockquote></div><div class="SIntrapara">This example, of course, isn&rsquo;t revealing, but consider this one:
</div><div class="SIntrapara"><blockquote class="SCodeFlow"><table cellspacing="0" cellpadding="0" class="RktBlk"><tr><td><span class="RktPn">(</span><span class="RktMeta">test</span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktMeta">run</span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktMeta">cps</span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktMeta">+</span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktVal">1</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktMeta">let/cc</span><span class="hspace">&nbsp;</span><span class="RktMeta">esc</span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktMeta">esc</span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktVal">3</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktMeta"></span></td></tr><tr><td><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktVal">4</span><span class="RktPn">)</span><span class="RktMeta"></span></td></tr></table></blockquote></div><div class="SIntrapara">This confirms that the addition actually happens.  But what about the
dynamic continuation?
</div><div class="SIntrapara"><blockquote class="SCodeFlow"><table cellspacing="0" cellpadding="0" class="RktBlk"><tr><td><span class="RktPn">(</span><span class="RktMeta">test</span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktMeta">run</span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktMeta">cps</span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktMeta">let/cc</span><span class="hspace">&nbsp;</span><span class="RktMeta">esc</span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktMeta">+</span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktVal">2</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktMeta">esc</span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktVal">3</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktMeta"></span></td></tr><tr><td><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktVal">3</span><span class="RktPn">)</span><span class="RktMeta"></span></td></tr></table></blockquote></div><div class="SIntrapara">This shows that the addition by <span class="stt">2</span> never happens, i.e., the
dynamic continuation is indeed ignored.  And just to be sure that the
continuation at the point of creation is respected, observe:
</div><div class="SIntrapara"><blockquote class="SCodeFlow"><table cellspacing="0" cellpadding="0" class="RktBlk"><tr><td><span class="RktPn">(</span><span class="RktMeta">test</span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktMeta">run</span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktMeta">cps</span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktMeta">+</span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktVal">1</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktMeta">let/cc</span><span class="hspace">&nbsp;</span><span class="RktMeta">esc</span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktMeta">+</span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktVal">2</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktMeta">esc</span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktVal">3</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktMeta"></span></td></tr><tr><td><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktVal">4</span><span class="RktPn">)</span><span class="RktMeta"></span></td></tr></table></blockquote></div></p><p>From these examples, you have probably noticed a familiar pattern:
<span class="stt">esc</span> here is behaving like an <span style="font-style: italic">exception</span>.  That is, if you
do not throw an exception (in this case, invoke a continuation) it&rsquo;s
as if it&rsquo;s not there, but if you do throw it, all pending intermediate
computation is ignored and computation returns to the point of
exception creation.</p><p><div class="SIntrapara"><span style="font-weight: bold">Exercise</span></div><div class="SIntrapara"><blockquote><p>Using <span class="stt">let/cc</span> and macros, create a <span class="stt">throw</span>/<span class="stt">catch</span>
mechanism.</p></blockquote></div></p><p>However, these examples only scratch the surface of available power,
because the continuation at the point of invocation is always an
extension of one at the point of creation: i.e., the latter is just
earlier in the stack than the former.  However, nothing actually
demands that <span class="stt">k</span> and <span class="stt">dyn-k</span> be at all related.  That means
they are in fact free to be <span style="font-style: italic">un</span>related, which means each can be
a distinct stack, so we can in fact easily implement stack-switching
procedures with them.</p><p><div class="SIntrapara"><span style="font-weight: bold">Exercise</span></div><div class="SIntrapara"><blockquote><p><div class="SIntrapara">To be properly analogous to <span class="stt">lambda</span>, we should have introduced a
construct called, say, <span class="stt">cont-lambda</span> with the following
expansion:
</div><div class="SIntrapara"><blockquote class="SCodeFlow"><table cellspacing="0" cellpadding="0" class="RktBlk"><tr><td><span class="RktPn">[</span><span class="RktPn">(</span><span class="RktMeta">_</span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktMeta">cont-lambda</span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktMeta">a</span><span class="RktPn">)</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta">b</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktMeta"></span></td></tr><tr><td><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktMeta">identifier?</span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktVal">#'</span><span class="RktMeta">a</span><span class="RktPn">)</span><span class="RktMeta"></span></td></tr><tr><td><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktVal">#'</span><span class="RktPn">(</span><span class="RktMeta">lambda</span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktMeta">k</span><span class="RktPn">)</span><span class="RktMeta"></span></td></tr><tr><td><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktMeta">k</span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktMeta">lambda</span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktMeta">a</span><span class="hspace">&nbsp;</span><span class="RktMeta">dyn-k</span><span class="RktPn">)</span><span class="RktMeta"></span></td></tr><tr><td><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktPn">(</span><span class="RktMeta">cps</span><span class="hspace">&nbsp;</span><span class="RktMeta">b</span><span class="RktPn">)</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta">k</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">]</span><span class="RktMeta"></span></td></tr></table></blockquote></div><div class="SIntrapara">Why didn&rsquo;t we?  Consider both the static typing implications, and also
how we might construct the above exception-like behaviors using this
construct instead.</div></p></blockquote></div></p><h5>14.6.1<tt>&nbsp;</tt><a name="(part._.Presentation_in_the_.Language)"></a>Presentation in the Language</h5><p>Writing programs in our little toy languages can soon become
frustrating.  Fortunately, Racket already provides a construct called
<span class="stt">call/cc</span> that reifies continuations.  <span class="stt">call/cc</span> is a
procedure of one argument, which is itself a procedure of one
argument, which Racket applies to the current continuation&#8212;<wbr></wbr>which is
a procedure of one argument.  Got that?</p><p><div class="SIntrapara">Fortunately, we can easily write <span class="stt">let/cc</span> as a macro over
<span class="stt">call/cc</span> and program with that instead.  Here it is:
</div><div class="SIntrapara"><blockquote class="SCodeFlow"><table cellspacing="0" cellpadding="0" class="RktBlk"><tr><td><span class="RktPn">(</span><span class="RktMeta">define-syntax</span><span class="hspace">&nbsp;</span><span class="RktMeta">let/cc</span></td></tr><tr><td><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktMeta">syntax-rules</span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktPn">)</span><span class="RktMeta"></span></td></tr><tr><td><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktPn">[</span><span class="RktPn">(</span><span class="RktMeta">let/cc</span><span class="hspace">&nbsp;</span><span class="RktMeta">k</span><span class="hspace">&nbsp;</span><span class="RktMeta">b</span><span class="RktPn">)</span><span class="RktMeta"></span></td></tr><tr><td><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktMeta">call/cc</span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktMeta">lambda</span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktMeta">k</span><span class="RktPn">)</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta">b</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">]</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktMeta"></span></td></tr></table></blockquote></div><div class="SIntrapara">To be sure, all our old tests still pass:
</div><div class="SIntrapara"><blockquote class="SCodeFlow"><table cellspacing="0" cellpadding="0" class="RktBlk"><tr><td><span class="RktPn">(</span><span class="RktMeta">test</span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktMeta">let/cc</span><span class="hspace">&nbsp;</span><span class="RktMeta">esc</span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktVal">3</span><span class="RktPn">)</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktVal">3</span><span class="RktPn">)</span><span class="RktMeta"></span></td></tr><tr><td><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktMeta">test</span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktMeta">let/cc</span><span class="hspace">&nbsp;</span><span class="RktMeta">esc</span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktMeta">esc</span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktVal">3</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktVal">3</span><span class="RktPn">)</span><span class="RktMeta"></span></td></tr><tr><td><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktMeta">test</span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktMeta">+</span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktVal">1</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktMeta">let/cc</span><span class="hspace">&nbsp;</span><span class="RktMeta">esc</span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktMeta">esc</span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktVal">3</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktVal">4</span><span class="RktPn">)</span><span class="RktMeta"></span></td></tr><tr><td><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktMeta">test</span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktMeta">let/cc</span><span class="hspace">&nbsp;</span><span class="RktMeta">esc</span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktMeta">+</span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktVal">2</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktMeta">esc</span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktVal">3</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktVal">3</span><span class="RktPn">)</span><span class="RktMeta"></span></td></tr><tr><td><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktMeta">test</span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktMeta">+</span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktVal">1</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktMeta">let/cc</span><span class="hspace">&nbsp;</span><span class="RktMeta">esc</span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktMeta">+</span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktVal">2</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktMeta">esc</span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktVal">3</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktVal">4</span><span class="RktPn">)</span><span class="RktMeta"></span></td></tr></table></blockquote></div></p><h5>14.6.2<tt>&nbsp;</tt><a name="(part._.Defining_.Generators)"></a>Defining Generators</h5><p><div class="SIntrapara">Now we can start to create interesting abstractions.  For instance,
let&rsquo;s build generators.  Whereas previously we needed to both <span class="Smaller">CPS</span>
expressions and pass around continuations, now this is done for us
automatically by <span class="stt">call/cc</span>.  Therefore, whenever we need the
current continuation, we simply conjure it up without having to
transform the program.  Thus the extra <span class="stt">...-k</span> parameters can
disappear with a <span class="stt">let/cc</span> in the same place to capture the same
continuation:
</div><div class="SIntrapara"><blockquote class="SCodeFlow"><table cellspacing="0" cellpadding="0" class="RktBlk"><tr><td><span class="RktPn">(</span><span class="RktMeta">define-syntax</span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktMeta">generator</span><span class="hspace">&nbsp;</span><span class="RktMeta">e</span><span class="RktPn">)</span><span class="RktMeta"></span></td></tr><tr><td><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktMeta">syntax-case</span><span class="hspace">&nbsp;</span><span class="RktMeta">e</span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktPn">)</span><span class="RktMeta"></span></td></tr><tr><td><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktPn">[</span><span class="RktPn">(</span><span class="RktMeta">generator</span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktMeta">yield</span><span class="RktPn">)</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktMeta">v</span><span class="RktPn">)</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta">b</span><span class="RktPn">)</span><span class="RktMeta"></span></td></tr><tr><td><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktVal">#'</span><span class="RktPn">(</span><span class="RktMeta">let</span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktPn">[</span><span class="RktMeta">where-to-go</span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktMeta">lambda</span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktMeta">v</span><span class="RktPn">)</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktMeta">error</span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktVal">'</span><span class="RktMeta">where-to-go</span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktVal">"nothing"</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">]</span><span class="RktPn">)</span><span class="RktMeta"></span></td></tr><tr><td><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktMeta">letrec</span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktPn">[</span><span class="RktMeta">resumer</span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktMeta">lambda</span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktMeta">v</span><span class="RktPn">)</span><span class="RktMeta"></span></td></tr><tr><td><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktMeta">begin</span><span class="hspace">&nbsp;</span><span class="RktMeta">b</span></td></tr><tr><td><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktMeta">error</span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktVal">'</span><span class="RktMeta">generator</span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktVal">"fell</span><span class="hspace">&nbsp;</span><span class="RktVal">through"</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">]</span><span class="RktMeta"></span></td></tr><tr><td><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktPn">[</span><span class="RktMeta">yield</span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktMeta">lambda</span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktMeta">v</span><span class="RktPn">)</span><span class="RktMeta"></span></td></tr><tr><td><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktMeta">let/cc</span><span class="hspace">&nbsp;</span><span class="RktMeta">gen-k</span></td></tr><tr><td><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktMeta">begin</span></td></tr><tr><td><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktMeta">set!</span><span class="hspace">&nbsp;</span><span class="RktMeta">resumer</span><span class="hspace">&nbsp;</span><span class="RktMeta">gen-k</span><span class="RktPn">)</span><span class="RktMeta"></span></td></tr><tr><td><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktMeta">where-to-go</span><span class="hspace">&nbsp;</span><span class="RktMeta">v</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">]</span><span class="RktPn">)</span><span class="RktMeta"></span></td></tr><tr><td><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktMeta">lambda</span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktMeta">v</span><span class="RktPn">)</span><span class="RktMeta"></span></td></tr><tr><td><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktMeta">let/cc</span><span class="hspace">&nbsp;</span><span class="RktMeta">dyn-k</span></td></tr><tr><td><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktMeta">begin</span></td></tr><tr><td><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktMeta">set!</span><span class="hspace">&nbsp;</span><span class="RktMeta">where-to-go</span><span class="hspace">&nbsp;</span><span class="RktMeta">dyn-k</span><span class="RktPn">)</span><span class="RktMeta"></span></td></tr><tr><td><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktMeta">resumer</span><span class="hspace">&nbsp;</span><span class="RktMeta">v</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">]</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktMeta"></span></td></tr></table></blockquote></div></p><p>Observe the close similarity between this code and the implementation
of generators by desugaring into <span class="Smaller">CPS</span> code.  Specifically, we can drop
the extra continuation arguments, and replace them with invocations of
<span class="stt">let/cc</span> that will capture precisely the same continuations.  The
rest of the code is fundamentally unchanged.</p><p><div class="SIntrapara"><span style="font-weight: bold">Exercise</span></div><div class="SIntrapara"><blockquote><p>What happens if we move the <span class="stt">let/cc</span>s and mutation to be the
first statement inside the <span class="stt">begin</span>s instead?</p></blockquote></div></p><p><div class="SIntrapara">We can, for instance, write a generator that iterates from the initial
value upward:
</div><div class="SIntrapara"><blockquote class="SCodeFlow"><table cellspacing="0" cellpadding="0" class="RktBlk"><tr><td><span class="RktPn">(</span><span class="RktMeta">define</span><span class="hspace">&nbsp;</span><span class="RktMeta">g1</span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktMeta">generator</span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktMeta">yield</span><span class="RktPn">)</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktMeta">v</span><span class="RktPn">)</span><span class="RktMeta"></span></td></tr><tr><td><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktMeta">letrec</span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktPn">[</span><span class="RktMeta">loop</span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktMeta">lambda</span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktMeta">n</span><span class="RktPn">)</span><span class="RktMeta"></span></td></tr><tr><td><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktMeta">begin</span></td></tr><tr><td><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktMeta">yield</span><span class="hspace">&nbsp;</span><span class="RktMeta">n</span><span class="RktPn">)</span><span class="RktMeta"></span></td></tr><tr><td><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktMeta">loop</span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktMeta">+</span><span class="hspace">&nbsp;</span><span class="RktMeta">n</span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktVal">1</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">]</span><span class="RktPn">)</span><span class="RktMeta"></span></td></tr><tr><td><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktMeta">loop</span><span class="hspace">&nbsp;</span><span class="RktMeta">v</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktMeta"></span></td></tr></table></blockquote></div><div class="SIntrapara">whose behavior is:
</div><div class="SIntrapara"><table cellspacing="0" cellpadding="0"><tr><td><p><span class="stt">&gt; (g1 10)</span></p></td></tr><tr><td><p><span class="stt">10</span></p></td></tr><tr><td><p><span class="stt">&gt; (g1 10)</span></p></td></tr><tr><td><p><span class="stt">11</span></p></td></tr><tr><td><p><span class="stt">&gt; (g1 0)</span></p></td></tr><tr><td><p><span class="stt">12</span></p></td></tr><tr><td><p><span class="stt">&gt;</span></p></td></tr></table></div><div class="SIntrapara">Because the body refers only to the initial value, ignoring that
returned by invoking <span class="stt">yield</span>, the values we pass on subsequent
invocations are irrelevant.  In contrast, consider this generator:
</div><div class="SIntrapara"><blockquote class="SCodeFlow"><table cellspacing="0" cellpadding="0" class="RktBlk"><tr><td><span class="RktPn">(</span><span class="RktMeta">define</span><span class="hspace">&nbsp;</span><span class="RktMeta">g2</span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktMeta">generator</span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktMeta">yield</span><span class="RktPn">)</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktMeta">v</span><span class="RktPn">)</span><span class="RktMeta"></span></td></tr><tr><td><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktMeta">letrec</span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktPn">[</span><span class="RktMeta">loop</span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktMeta">lambda</span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktMeta">n</span><span class="RktPn">)</span><span class="RktMeta"></span></td></tr><tr><td><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktMeta">loop</span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktMeta">+</span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktMeta">yield</span><span class="hspace">&nbsp;</span><span class="RktMeta">n</span><span class="RktPn">)</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta">n</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">]</span><span class="RktPn">)</span><span class="RktMeta"></span></td></tr><tr><td><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktMeta">loop</span><span class="hspace">&nbsp;</span><span class="RktMeta">v</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktMeta"></span></td></tr></table></blockquote></div><div class="SIntrapara">On its first invocation, it returns whatever value it was supplied.
On subsequent invocations, this value is added to that provided on
re-entry into the generator.  In other words, this generator
additively accumulates all values given to it:
</div><div class="SIntrapara"><table cellspacing="0" cellpadding="0"><tr><td><p><span class="stt">&gt; (g2 10)</span></p></td></tr><tr><td><p><span class="stt">10</span></p></td></tr><tr><td><p><span class="stt">&gt; (g2 15)</span></p></td></tr><tr><td><p><span class="stt">25</span></p></td></tr><tr><td><p><span class="stt">&gt; (g2 5)</span></p></td></tr><tr><td><p><span class="stt">30</span></p></td></tr></table></div></p><p><div class="SIntrapara"><span style="font-weight: bold">Exercise</span></div><div class="SIntrapara"><blockquote><p>Now that you&rsquo;ve seen how to implement generators using <span class="stt">call/cc</span>
and <span class="stt">let/cc</span>, implement coroutines and threads as well.</p></blockquote></div></p><h5>14.6.3<tt>&nbsp;</tt><a name="(part._.Defining_.Threads)"></a>Defining Threads</h5><p><div class="SIntrapara">Having done generators, let&rsquo;s do another, similar primitive: threads.
That is, let&rsquo;s assume we want to be able to write a program such as
this:
</div><div class="SIntrapara"><blockquote class="SCodeFlow"><table cellspacing="0" cellpadding="0" class="RktBlk"><tr><td><span class="RktPn">(</span><span class="RktMeta">define</span><span class="hspace">&nbsp;</span><span class="RktMeta">d</span><span class="hspace">&nbsp;</span><span class="RktMeta">display</span><span class="RktPn">)</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktCmt">;;</span><span class="hspace">&nbsp;</span><span class="RktCmt">a</span><span class="hspace">&nbsp;</span><span class="RktCmt">useful</span><span class="hspace">&nbsp;</span><span class="RktCmt">shorthand</span><span class="hspace">&nbsp;</span><span class="RktCmt">in</span><span class="hspace">&nbsp;</span><span class="RktCmt">what</span><span class="hspace">&nbsp;</span><span class="RktCmt">follows</span><span class="RktMeta"></span></td></tr><tr><td><span class="RktMeta">&#160;</span></td></tr><tr><td><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktMeta">scheduler-loop-0</span></td></tr><tr><td><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktMeta">list</span></td></tr><tr><td><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktMeta">thread-0</span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktMeta">y</span><span class="RktPn">)</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktMeta">d</span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktVal">"t1-1</span><span class="hspace">&nbsp;&nbsp;</span><span class="RktVal">"</span><span class="RktPn">)</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktMeta">y</span><span class="RktPn">)</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktMeta">d</span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktVal">"t1-2</span><span class="hspace">&nbsp;&nbsp;</span><span class="RktVal">"</span><span class="RktPn">)</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktMeta">y</span><span class="RktPn">)</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktMeta">d</span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktVal">"t1-3</span><span class="hspace">&nbsp;</span><span class="RktVal">"</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktMeta"></span></td></tr><tr><td><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktMeta">thread-0</span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktMeta">y</span><span class="RktPn">)</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktMeta">d</span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktVal">"t2-1</span><span class="hspace">&nbsp;&nbsp;</span><span class="RktVal">"</span><span class="RktPn">)</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktMeta">y</span><span class="RktPn">)</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktMeta">d</span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktVal">"t2-2</span><span class="hspace">&nbsp;&nbsp;</span><span class="RktVal">"</span><span class="RktPn">)</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktMeta">y</span><span class="RktPn">)</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktMeta">d</span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktVal">"t2-3</span><span class="hspace">&nbsp;</span><span class="RktVal">"</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktMeta"></span></td></tr><tr><td><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktMeta">thread-0</span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktMeta">y</span><span class="RktPn">)</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktMeta">d</span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktVal">"t3-1</span><span class="hspace">&nbsp;&nbsp;</span><span class="RktVal">"</span><span class="RktPn">)</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktMeta">y</span><span class="RktPn">)</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktMeta">d</span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktVal">"t3-2</span><span class="hspace">&nbsp;&nbsp;</span><span class="RktVal">"</span><span class="RktPn">)</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktMeta">y</span><span class="RktPn">)</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktMeta">d</span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktVal">"t3-3</span><span class="hspace">&nbsp;</span><span class="RktVal">"</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktMeta"></span></td></tr></table></blockquote></div><div class="SIntrapara">and expect the output
</div><div class="SIntrapara"><table cellspacing="0" cellpadding="0"><tr><td><p><span class="stt">t1-1</span><span class="hspace">&nbsp;&nbsp;</span><span class="stt">t2-1</span><span class="hspace">&nbsp;&nbsp;</span><span class="stt">t3-1</span><span class="hspace">&nbsp;&nbsp;</span><span class="stt">t1-2</span><span class="hspace">&nbsp;&nbsp;</span><span class="stt">t2-2</span><span class="hspace">&nbsp;&nbsp;</span><span class="stt">t3-2</span><span class="hspace">&nbsp;&nbsp;</span><span class="stt">t1-3 t2-3 t3-3</span></p></td></tr></table></div><div class="SIntrapara">We&rsquo;ll build all the pieces necessary to achieve this.</div></p><p>Let&rsquo;s start by defining the thread scheduler.  It consumes a list of
&ldquo;threads&rdquo;, whose interface we assume will be a procedure that
consumes a continuation to which it eventually yields control.  Each
time the scheduler reactivates the thread, it supplies it with a
continuation.  The scheduler might be choose between threads in a
simple <span style="font-style: italic">round-robin</span> manner, or it might use some more complex
algorithm; the details of how it chooses don&rsquo;t concern us here.</p><p>As with generators, we&rsquo;ll assume that yielding is done by invoking a
procedure named by the user: <span class="stt">y</span>, above.  We could use name
capture [REF] to automatically bind a name like <span class="stt">yield</span>.</p><p>More importantly, notice that the user of the thread system manually
yields control.  This is called <span style="font-style: italic">cooperative multitasking</span>.
Instead, we could have chosen to have a timer or other intrinsic
mechanism automtically yield without the user&rsquo;s permission; this is
called <span style="font-style: italic">preemptive multitasking</span> (because the system
&ldquo;pre-empts&rdquo;&#8212;<wbr></wbr>i.e., wrests control from&#8212;<wbr></wbr>the thread).  While the
distinction is important for buildling systems, it is not interesting
from the perspective of setting up the continuations.</p><p><div class="SIntrapara"><span style="font-weight: bold">Exercise</span></div><div class="SIntrapara"><blockquote><p>After we are done building cooperative multitasking, implement
preemptive multitasking.  What changes?</p></blockquote></div></p><p><div class="SIntrapara">With our stated constraints, we can write a first scheduler.  It
consumes a lists of threads and continues executing so long as there
are threads remaining.  Each time, it applies the thread procedure to
a continuation that represents returning to the scheduler and
proceeding to the next thread:
</div><div class="SIntrapara"><blockquote class="SCodeFlow"><table cellspacing="0" cellpadding="0" class="RktBlk"><tr><td><span class="RktPn">(</span><span class="RktMeta">define</span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktMeta">scheduler-loop-0</span><span class="hspace">&nbsp;</span><span class="RktMeta">threads</span><span class="RktPn">)</span><span class="RktMeta"></span></td></tr><tr><td><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktMeta">cond</span></td></tr><tr><td><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktPn">[</span><span class="RktPn">(</span><span class="RktMeta">empty?</span><span class="hspace">&nbsp;</span><span class="RktMeta">threads</span><span class="RktPn">)</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktVal">'</span><span class="RktMeta">done</span><span class="RktPn">]</span><span class="RktMeta"></span></td></tr><tr><td><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktPn">[</span><span class="RktPn">(</span><span class="RktMeta">cons?</span><span class="hspace">&nbsp;</span><span class="RktMeta">threads</span><span class="RktPn">)</span><span class="RktMeta"></span></td></tr><tr><td><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktMeta">begin</span></td></tr><tr><td><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktMeta">let/cc</span><span class="hspace">&nbsp;</span><span class="RktMeta">after-thread</span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktPn">(</span><span class="RktMeta">first</span><span class="hspace">&nbsp;</span><span class="RktMeta">threads</span><span class="RktPn">)</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta">after-thread</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktMeta"></span></td></tr><tr><td><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktMeta">scheduler-loop-0</span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktMeta">append</span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktMeta">rest</span><span class="hspace">&nbsp;</span><span class="RktMeta">threads</span><span class="RktPn">)</span><span class="RktMeta"></span></td></tr><tr><td><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktMeta">list</span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktMeta">first</span><span class="hspace">&nbsp;</span><span class="RktMeta">threads</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">]</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktMeta"></span></td></tr></table></blockquote></div><div class="SIntrapara">When the recipient thread invokes the continuation bound to
<span class="stt">after-thread</span>, control returns to the end of the first statement
in the <span class="stt">begin</span> sequence.  As a result, the value supplied to the
continuation is ignored (and can hence be any dummy value; we&rsquo;ll chose
<span class="stt"></span><span class="stt">&rsquo;</span><span class="stt">dummy</span>, so that we can easily spot it if it shows up in
undesired places).  Control then proceeds with the rest of the
scheduler loop after appending the most recently invoked thread to
the end of the list of threads (i.e., treating the list as a circular
queue).</div></p><p><div class="SIntrapara">Now let&rsquo;s define a thread.  As we&rsquo;ve said, it will be a procedure of
one argument, the scheduler&rsquo;s continuation.  Because the thread needs
to <span style="font-style: italic">resume</span>, i.e., continue where it left off, presumably it must
store where it last was: we&rsquo;ll call this <span class="stt">thread-resumer</span>.
Initially this is the entire thread body, but on subsequent instances
it will be a continuation: specifically, the continuation of
invoking <span class="stt">yield</span>.  Thus, we obtain the following skeleton:
</div><div class="SIntrapara"><blockquote class="SCodeFlow"><table cellspacing="0" cellpadding="0" class="RktBlk"><tr><td><span class="RktPn">(</span><span class="RktMeta">define-syntax</span><span class="hspace">&nbsp;</span><span class="RktMeta">thread-0</span></td></tr><tr><td><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktMeta">syntax-rules</span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktPn">)</span><span class="RktMeta"></span></td></tr><tr><td><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktPn">[</span><span class="RktPn">(</span><span class="RktMeta">thread</span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktMeta">yielder</span><span class="RktPn">)</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta">b</span><span class="hspace">&nbsp;</span><span class="RktMeta">...</span><span class="RktPn">)</span><span class="RktMeta"></span></td></tr><tr><td><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktMeta">letrec</span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktPn">[</span><span class="RktMeta">thread-resumer</span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktMeta">lambda</span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktMeta">_</span><span class="RktPn">)</span><span class="RktMeta"></span></td></tr><tr><td><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktMeta">begin</span><span class="hspace">&nbsp;</span><span class="RktMeta">b</span><span class="hspace">&nbsp;</span><span class="RktMeta">...</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">]</span><span class="RktPn">)</span><span class="RktMeta"></span></td></tr><tr><td><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktMeta">lambda</span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktMeta">sched-k</span><span class="RktPn">)</span><span class="RktMeta"></span></td></tr><tr><td><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktMeta">thread-resumer</span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktVal">'</span><span class="RktMeta">dummy</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">]</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktMeta"></span></td></tr></table></blockquote></div><div class="SIntrapara">That still leaves the yielder.  It needs to be a procedure of no
arguments that stores the thread&rsquo;s continuation in
<span class="stt">thread-resumer</span>, and then invoke the scheduler continuation with
<span class="stt"></span><span class="stt">&rsquo;</span><span class="stt">dummy</span>.  However, <span style="font-style: italic">which</span> scheduler continuation does it
need to invoke?  Not the one provided on thread initiation, but rather
the most recent one.  Thus, we must somehow &ldquo;thread&rdquo; the value in
<span class="stt">sched-k</span> to the yielder.  There are many ways to accomplish it,
but the simplest, perhaps most brutal, way is to simply reconstruct
the yielder on each thread resumption, always closed over the most
recent value of <span class="stt">sched-k</span>:
</div><div class="SIntrapara"><blockquote class="SCodeFlow"><table cellspacing="0" cellpadding="0" class="RktBlk"><tr><td><span class="RktPn">(</span><span class="RktMeta">define-syntax</span><span class="hspace">&nbsp;</span><span class="RktMeta">thread-0</span></td></tr><tr><td><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktMeta">syntax-rules</span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktPn">)</span><span class="RktMeta"></span></td></tr><tr><td><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktPn">[</span><span class="RktPn">(</span><span class="RktMeta">thread</span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktMeta">yielder</span><span class="RktPn">)</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta">b</span><span class="hspace">&nbsp;</span><span class="RktMeta">...</span><span class="RktPn">)</span><span class="RktMeta"></span></td></tr><tr><td><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktMeta">letrec</span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktPn">[</span><span class="RktMeta">thread-resumer</span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktMeta">lambda</span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktMeta">_</span><span class="RktPn">)</span><span class="RktMeta"></span></td></tr><tr><td><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktMeta">begin</span><span class="hspace">&nbsp;</span><span class="RktMeta">b</span><span class="hspace">&nbsp;</span><span class="RktMeta">...</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">]</span><span class="RktMeta"></span></td></tr><tr><td><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktPn">[</span><span class="RktMeta">yielder</span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktMeta">lambda</span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktPn">)</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktMeta">error</span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktVal">'</span><span class="RktMeta">yielder</span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktVal">"nothing</span><span class="hspace">&nbsp;</span><span class="RktVal">here"</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">]</span><span class="RktPn">)</span><span class="RktMeta"></span></td></tr><tr><td><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktMeta">lambda</span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktMeta">sched-k</span><span class="RktPn">)</span><span class="RktMeta"></span></td></tr><tr><td><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktMeta">begin</span></td></tr><tr><td><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktMeta">set!</span><span class="hspace">&nbsp;</span><span class="RktMeta">yielder</span></td></tr><tr><td><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktMeta">lambda</span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktPn">)</span><span class="RktMeta"></span></td></tr><tr><td><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktMeta">let/cc</span><span class="hspace">&nbsp;</span><span class="RktMeta">thread-k</span></td></tr><tr><td><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktMeta">begin</span></td></tr><tr><td><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktMeta">set!</span><span class="hspace">&nbsp;</span><span class="RktMeta">thread-resumer</span><span class="hspace">&nbsp;</span><span class="RktMeta">thread-k</span><span class="RktPn">)</span><span class="RktMeta"></span></td></tr><tr><td><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktMeta">sched-k</span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktVal">'</span><span class="RktMeta">dummy</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktMeta"></span></td></tr><tr><td><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktMeta">thread-resumer</span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktVal">'</span><span class="RktMeta">tres</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">]</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktMeta"></span></td></tr></table></blockquote></div><div class="SIntrapara">When we run this ensemble, we get:
</div><div class="SIntrapara"><table cellspacing="0" cellpadding="0"><tr><td><p><span class="stt">t1-1</span><span class="hspace">&nbsp;&nbsp;</span><span class="stt">t2-1</span><span class="hspace">&nbsp;&nbsp;</span><span class="stt">t3-1</span><span class="hspace">&nbsp;&nbsp;</span><span class="stt">t1-2</span><span class="hspace">&nbsp;&nbsp;</span><span class="stt">t2-2</span><span class="hspace">&nbsp;&nbsp;</span><span class="stt">t3-2</span><span class="hspace">&nbsp;&nbsp;</span><span class="stt">t1-3 t2-3 t3-3</span></p></td></tr></table></div><div class="SIntrapara">Hey, that&rsquo;s what we wanted!  But it continues:
</div><div class="SIntrapara"><table cellspacing="0" cellpadding="0"><tr><td><p><span class="stt">t1-3 t2-3 t3-3 t1-3 t2-3 t3-3 t1-3 t2-3 t3-3</span></p></td></tr></table></div><div class="SIntrapara">Hmmm.</div></p><p>What&rsquo;s happening?  Well, we&rsquo;ve been quiet all along about what needs
to happen when a thread reaches its end.  In fact, control just
returns to the thread scheduler, which appends the thread to the end
of the queue, and when the thread comes to the head of the queue
again, control resumes from the same previously stored continuation:
the one corresponding to printing the third value.  This prints,
control returns, the thread is appended...ad infinitum.</p><p><div class="SIntrapara">Clearly, we need the thread scheduler to be notified when a thread has
terminated, so that the scheduler can remove it from the thread
queue.  We&rsquo;ll create a simple datatype to represent this signal:
</div><div class="SIntrapara"><blockquote class="SCodeFlow"><table cellspacing="0" cellpadding="0" class="RktBlk"><tr><td><span class="RktPn">(</span><span class="RktMeta">define-type</span><span class="hspace">&nbsp;</span><span class="RktMeta">ThreadStatus</span></td></tr><tr><td><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktPn">[</span><span class="RktMeta">Tsuspended</span><span class="RktPn">]</span><span class="RktMeta"></span></td></tr><tr><td><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktPn">[</span><span class="RktMeta">Tdone</span><span class="RktPn">]</span><span class="RktPn">)</span><span class="RktMeta"></span></td></tr></table></blockquote></div><div class="SIntrapara">(In a real system, of course, these status messages might also carry
informative values from the computation.)  We must now modify our
scheduler to actually check for and use these values:
</div><div class="SIntrapara"><blockquote class="SCodeFlow"><table cellspacing="0" cellpadding="0" class="RktBlk"><tr><td><span class="RktPn">(</span><span class="RktMeta">define</span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktMeta">scheduler-loop-1</span><span class="hspace">&nbsp;</span><span class="RktMeta">threads</span><span class="RktPn">)</span><span class="RktMeta"></span></td></tr><tr><td><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktMeta">cond</span></td></tr><tr><td><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktPn">[</span><span class="RktPn">(</span><span class="RktMeta">empty?</span><span class="hspace">&nbsp;</span><span class="RktMeta">threads</span><span class="RktPn">)</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktVal">'</span><span class="RktMeta">done</span><span class="RktPn">]</span><span class="RktMeta"></span></td></tr><tr><td><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktPn">[</span><span class="RktPn">(</span><span class="RktMeta">cons?</span><span class="hspace">&nbsp;</span><span class="RktMeta">threads</span><span class="RktPn">)</span><span class="RktMeta"></span></td></tr><tr><td><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktMeta">type-case</span><span class="hspace">&nbsp;</span><span class="RktMeta">ThreadStatus</span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktMeta">let/cc</span><span class="hspace">&nbsp;</span><span class="RktMeta">after-thread</span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktPn">(</span><span class="RktMeta">first</span><span class="hspace">&nbsp;</span><span class="RktMeta">threads</span><span class="RktPn">)</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta">after-thread</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktMeta"></span></td></tr><tr><td><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktPn">[</span><span class="RktMeta">Tsuspended</span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktPn">)</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktMeta">scheduler-loop-1</span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktMeta">append</span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktMeta">rest</span><span class="hspace">&nbsp;</span><span class="RktMeta">threads</span><span class="RktPn">)</span><span class="RktMeta"></span></td></tr><tr><td><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktMeta">list</span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktMeta">first</span><span class="hspace">&nbsp;</span><span class="RktMeta">threads</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">]</span><span class="RktMeta"></span></td></tr><tr><td><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktPn">[</span><span class="RktMeta">Tdone</span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktPn">)</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktMeta">scheduler-loop-1</span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktMeta">rest</span><span class="hspace">&nbsp;</span><span class="RktMeta">threads</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">]</span><span class="RktPn">)</span><span class="RktPn">]</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktMeta"></span></td></tr></table></blockquote></div><div class="SIntrapara">We have to now modify our thread representation in two ways: it must
provide <span class="stt">Tsuspended</span> to the scheduler&rsquo;s continuation on
intermediate returns, and provide <span class="stt">Tdone</span> when it terminates.
Where does it terminate?  After executing the code in the body,
<span class="stt">b ...</span>.  Observe, finally, that the termination process must be
sure to use the latest scheduler continuation, just as yielding does.
Thus:
</div><div class="SIntrapara"><blockquote class="SCodeFlow"><table cellspacing="0" cellpadding="0" class="RktBlk"><tr><td><span class="RktPn">(</span><span class="RktMeta">define-syntax</span><span class="hspace">&nbsp;</span><span class="RktMeta">thread-1</span></td></tr><tr><td><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktMeta">syntax-rules</span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktPn">)</span><span class="RktMeta"></span></td></tr><tr><td><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktPn">[</span><span class="RktPn">(</span><span class="RktMeta">thread</span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktMeta">yielder</span><span class="RktPn">)</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta">b</span><span class="hspace">&nbsp;</span><span class="RktMeta">...</span><span class="RktPn">)</span><span class="RktMeta"></span></td></tr><tr><td><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktMeta">letrec</span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktPn">[</span><span class="RktMeta">thread-resumer</span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktMeta">lambda</span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktMeta">_</span><span class="RktPn">)</span><span class="RktMeta"></span></td></tr><tr><td><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktMeta">begin</span><span class="hspace">&nbsp;</span><span class="RktMeta">b</span><span class="hspace">&nbsp;</span><span class="RktMeta">...</span></td></tr><tr><td><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktMeta">finisher</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">]</span><span class="RktMeta"></span></td></tr><tr><td><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktPn">[</span><span class="RktMeta">finisher</span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktMeta">lambda</span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktPn">)</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktMeta">error</span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktVal">'</span><span class="RktMeta">finisher</span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktVal">"nothing</span><span class="hspace">&nbsp;</span><span class="RktVal">here"</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">]</span><span class="RktMeta"></span></td></tr><tr><td><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktPn">[</span><span class="RktMeta">yielder</span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktMeta">lambda</span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktPn">)</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktMeta">error</span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktVal">'</span><span class="RktMeta">yielder</span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktVal">"nothing</span><span class="hspace">&nbsp;</span><span class="RktVal">here"</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">]</span><span class="RktPn">)</span><span class="RktMeta"></span></td></tr><tr><td><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktMeta">lambda</span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktMeta">sched-k</span><span class="RktPn">)</span><span class="RktMeta"></span></td></tr><tr><td><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktMeta">begin</span></td></tr><tr><td><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktMeta">set!</span><span class="hspace">&nbsp;</span><span class="RktMeta">finisher</span></td></tr><tr><td><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktMeta">lambda</span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktPn">)</span><span class="RktMeta"></span></td></tr><tr><td><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktMeta">let/cc</span><span class="hspace">&nbsp;</span><span class="RktMeta">thread-k</span></td></tr><tr><td><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktMeta">sched-k</span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktMeta">Tdone</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktMeta"></span></td></tr><tr><td><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktMeta">set!</span><span class="hspace">&nbsp;</span><span class="RktMeta">yielder</span></td></tr><tr><td><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktMeta">lambda</span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktPn">)</span><span class="RktMeta"></span></td></tr><tr><td><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktMeta">let/cc</span><span class="hspace">&nbsp;</span><span class="RktMeta">thread-k</span></td></tr><tr><td><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktMeta">begin</span></td></tr><tr><td><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktMeta">set!</span><span class="hspace">&nbsp;</span><span class="RktMeta">thread-resumer</span><span class="hspace">&nbsp;</span><span class="RktMeta">thread-k</span><span class="RktPn">)</span><span class="RktMeta"></span></td></tr><tr><td><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktMeta">sched-k</span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktMeta">Tsuspended</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktMeta"></span></td></tr><tr><td><span class="RktMeta"></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktMeta">thread-resumer</span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktVal">'</span><span class="RktMeta">tres</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">]</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktMeta"></span></td></tr></table></blockquote></div><div class="SIntrapara">If we now replace <span class="stt">scheduler-loop-0</span> with <span class="stt">scheduler-loop-1</span>
and <span class="stt">thread-0</span> with <span class="stt">thread-1</span> and re-run our example
program above, we get just the output we desire.</div></p><h5>14.6.4<tt>&nbsp;</tt><a name="(part._.Better_.Primitives_for_.Web_.Programming)"></a>Better Primitives for Web Programming</h5><p>Finally, to tie the knot back to where we began, let&rsquo;s return to
<span class="stt">read-number</span>: observe that, if the language running the server
program has <span class="stt">call/cc</span>, instead of having to <span class="Smaller">CPS</span> the entire
program, we can simply capture the current continuation and save it in
the hash table, leaving the program structure again intact.</p><div class="navsetbottom"><span class="navleft"><div class="nosearchform"></div>&nbsp;&nbsp;</span><span class="navright">&nbsp;&nbsp;<a href="Desugaring_as_a_Language_Feature.html" title="backward to &quot;13 Desugaring as a Language Feature&quot;" data-pltdoc="x">&larr; prev</a>&nbsp;&nbsp;<a href="index.html" title="up to &quot;Programming Languages: Application and Interpretation&quot;" data-pltdoc="x">up</a>&nbsp;&nbsp;<a href="types.html" title="forward to &quot;15 Checking Program Invariants Statically: Types&quot;" data-pltdoc="x">next &rarr;</a></span>&nbsp;</div></div></div><div id="contextindicator">&nbsp;</div></body></html>